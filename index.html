<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NefliClon</title>
    <style>
        /* Estilos generales */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
        }
        
        body {
            background-color: #141414;
            color: #fff;
            line-height: 1.4;
        }
        
        a {
            text-decoration: none;
            color: inherit;
        }
        
        button {
            cursor: pointer;
            border: none;
        }
        
        /* Header y navegación */
        .header {
            position: fixed;
            top: 0;
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 50px;
            z-index: 1000;
            transition: background-color 0.3s;
        }
        
        .header.scrolled {
            background-color: #141414;
        }
        
        .logo {
            display: flex;
            align-items: center;
            font-size: 1.8rem;
            font-weight: bold;
        }
        
        .logo span {
            color: #E50914;
        }
        
        .nav-left {
            display: flex;
            align-items: center;
        }
        
        .nav-links {
            display: flex;
            list-style: none;
            margin-left: 30px;
        }
        
        .nav-links li {
            margin-left: 20px;
        }
        
        .nav-links a {
            font-size: 14px;
            transition: color 0.3s;
        }
        
        .nav-links a:hover {
            color: #b3b3b3;
        }
        
        .nav-right {
            display: flex;
            align-items: center;
            position: relative;
        }
        
        .search-icon, .notifications, .profile {
            margin-left: 20px;
            cursor: pointer;
            font-size: 1.2rem;
            transition: transform 0.3s;
        }

        .search-icon:hover, .notifications:hover, .profile:hover {
            transform: scale(1.1);
        }

        /* Estilos del buscador en header */
        .search-input {
            position: absolute;
            right: 90px;
            top: 50%;
            transform: translateY(-50%);
            width: 0;
            height: 32px;
            padding: 0;
            border: none;
            border-radius: 16px;
            background-color: #333;
            color: #fff;
            font-size: 14px;
            outline: none;
            opacity: 0;
            transition: width 0.4s ease-in-out, opacity 0.4s ease-in-out, padding 0.4s ease-in-out;
        }

        .search-input.show {
            width: 200px;
            padding: 0 15px;
            opacity: 1;
        }

        .search-input::placeholder {
            color: #b3b3b3;
        }

        /* Página de búsqueda */
        .search-page {
            display: none;
            padding: 120px 50px 50px;
            min-height: 100vh;
        }

        .search-header {
            margin-bottom: 30px;
        }

        .search-title {
            font-size: 2rem;
            margin-bottom: 20px;
            color: #fff;
        }

        .search-results-count {
            color: #b3b3b3;
            font-size: 1rem;
            margin-bottom: 20px;
        }

        /* Grid de resultados de búsqueda */
        .search-results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .search-result-item {
            position: relative;
            border-radius: 4px;
            overflow: hidden;
            transition: transform 0.3s;
            cursor: pointer;
            aspect-ratio: 2/3;
        }

        .search-result-item:hover {
            transform: scale(1.05);
            z-index: 10;
        }

        .search-result-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

        .search-result-info {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to top, rgba(0,0,0,0.9), transparent);
            padding: 15px 10px 10px;
            transform: translateY(100%);
            transition: transform 0.3s;
        }

        .search-result-item:hover .search-result-info {
            transform: translateY(0);
        }

        .search-result-title {
            font-size: 0.9rem;
            font-weight: bold;
            margin-bottom: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .search-result-type {
            font-size: 0.8rem;
            color: #b3b3b3;
        }

        .no-results {
            text-align: center;
            padding: 50px;
            color: #b3b3b3;
            font-size: 1.2rem;
        }

        /* Indicador de búsqueda en Mi Lista */
        .search-result-item.in-mylist::after {
            content: '✓';
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(0,0,0,0.7);
            color: #E50914;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            z-index: 2;
        }

        /* Menú desplegable del perfil */
        .profile-menu {
            display: none;
            position: absolute;
            top: 60px;
            right: 50px;
            background-color: #141414;
            border: 1px solid #333;
            border-radius: 4px;
            padding: 10px 0;
            min-width: 150px;
            z-index: 1001;
        }

        .profile-menu.show {
            display: block;
        }

        .profile-menu-item {
            padding: 10px 20px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .profile-menu-item:hover {
            background-color: #333;
        }

        .profile-menu-item.delete {
            color: #e50914;
        }
        
        /* Banner principal */
        .banner {
            position: relative;
            height: 80vh;
            background: linear-gradient(to top, #141414, transparent 50%), 
                        linear-gradient(to right, #141414, transparent 30%),
                        url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="1200" height="675" viewBox="0 0 1200 675"><rect width="1200" height="675" fill="%23222"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" font-family="Arial" font-size="24" fill="%23fff">Imagen de película destacada</text></svg>');
            background-size: cover;
            background-position: center;
            display: flex;
            align-items: center;
            padding: 0 50px;
        }
        
        .banner-content {
            max-width: 40%;
            z-index: 2;
        }
        
        .banner-title {
            font-size: 3rem;
            font-weight: bold;
            margin-bottom: 20px;
        }
        
        .banner-buttons {
            display: flex;
            margin-top: 20px;
        }
        
        .banner-button {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 8px 24px;
            border-radius: 4px;
            font-weight: bold;
            margin-right: 10px;
            cursor: pointer;
            transition: opacity 0.3s;
        }
        
        .banner-button:hover {
            opacity: 0.8;
        }
        
        .play-button {
            background-color: #fff;
            color: #000;
        }
        
        .info-button {
            background-color: rgba(109, 109, 110, 0.7);
            color: #fff;
        }
        
        .banner-description {
            margin-top: 20px;
            font-size: 1.1rem;
            line-height: 1.5;
            color: #d2d2d2;
        }
        
        /* Secciones de contenido */
        .content-section {
            padding: 0 50px;
            margin-bottom: 40px;
        }
        
        .section-title {
            font-size: 1.4rem;
            margin-bottom: 15px;
            font-weight: bold;
        }
        
        /* Carrusel de películas */
        .carousel {
            position: relative;
            overflow: hidden;
        }
        
        .carousel-container {
            display: flex;
            gap: 5px;
            overflow-x: auto;
            scrollbar-width: none;
            -ms-overflow-style: none;
            scroll-behavior: smooth;
        }
        
        .carousel-container::-webkit-scrollbar {
            display: none;
        }
        
        .carousel-item {
            min-width: calc(20% - 4px);
            position: relative;
            border-radius: 4px;
            overflow: hidden;
            transition: transform 0.3s;
            cursor: pointer;
            flex-shrink: 0;
        }
        
        .carousel-item:hover {
            transform: scale(1.1);
            z-index: 10;
        }
        
        .carousel-item img {
            width: 100%;
            height: 450px;
            object-fit: cover;
            display: block;
        }
        
        /* CORRECCIÓN: Solo mostrar check cuando hay elementos en Mi Lista y al pasar el mouse */
        .carousel-item.in-mylist:hover::after {
            content: '✓';
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(0,0,0,0.7);
            color: #E50914;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            z-index: 2;
        }
        
        .progress-bar-wrapper {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background-color: rgba(255, 255, 255, 0.3);
        }
        
        .progress-bar-fill {
            height: 100%;
            background-color: #e50914;
            transition: width 0.3s ease;
        }
        
        .carousel-nav {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 50px;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 5;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .carousel:hover .carousel-nav {
            opacity: 1;
        }
        
        .carousel-nav.prev {
            left: 0;
        }
        
        .carousel-nav.next {
            right: 0;
        }
        
        /* Vista de cuadrícula para series y películas */
        .grid-view {
            display: none;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .grid-item {
            position: relative;
            border-radius: 4px;
            overflow: hidden;
            transition: transform 0.3s;
            cursor: pointer;
            aspect-ratio: 2/3;
        }
        
        .grid-item:hover {
            transform: scale(1.05);
            z-index: 10;
        }
        
        .grid-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }
        
        /* CORRECCIÓN: Solo mostrar check en cuadrícula cuando hay elementos en Mi Lista y al pasar el mouse */
        .grid-item.in-mylist:hover::after {
            content: '✓';
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(0,0,0,0.7);
            color: #E50914;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            z-index: 2;
        }
        
        /* Botón de cambio de vista para series y películas */
        .view-toggle-section {
            display: none;
            justify-content: flex-end;
            margin-bottom: 15px;
        }
        
        .view-toggle-button {
            background-color: #333;
            color: #fff;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .view-toggle-button:hover {
            background-color: #444;
        }
        
        /* Vista horizontal de series (solo en Mi Lista) */
        .horizontal-list {
            display: none;
            flex-direction: column;
            gap: 15px;
        }
        
        .horizontal-item {
            display: flex;
            background-color: #2f2f2f;
            border-radius: 8px;
            overflow: hidden;
            transition: transform 0.3s, background-color 0.3s;
            cursor: pointer;
        }
        
        .horizontal-item:hover {
            transform: translateY(-5px);
            background-color: #3a3a3a;
        }
        
        .horizontal-item-image {
            width: 150px;
            height: 200px;
            flex-shrink: 0;
            background-size: cover;
            background-position: center;
            position: relative;
        }
        
        .horizontal-item.in-mylist:hover::after {
            content: '✓';
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.7);
            color: #E50914;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            z-index: 2;
        }
        
        .horizontal-item-content {
            padding: 20px;
            flex-grow: 1;
        }
        
        .horizontal-item-title {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .horizontal-item-info {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            color: #aaa;
            font-size: 0.9rem;
        }
        
        .horizontal-item-rating {
            color: #46d369;
            font-weight: bold;
        }
        
        .horizontal-item-description {
            margin-bottom: 15px;
            line-height: 1.5;
            color: #d2d2d2;
        }
        
        .horizontal-item-seasons {
            margin-bottom: 15px;
        }
        
        .horizontal-item-buttons {
            display: flex;
            gap: 10px;
        }
        
        .horizontal-item-button {
            padding: 8px 16px;
            border-radius: 4px;
            font-weight: bold;
            cursor: pointer;
            transition: opacity 0.3s;
        }
        
        .horizontal-item-button:hover {
            opacity: 0.8;
        }
        
        /* Modal de detalles de serie */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            overflow-y: auto;
        }
        
        .modal-content {
            background-color: #181818;
            margin: 50px auto;
            width: 90%;
            max-width: 1000px;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .modal-header {
            position: relative;
            height: 60vh;
            background-size: cover;
            background-position: center;
        }
        
        .modal-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            cursor: pointer;
        }
        
        .modal-body {
            padding: 30px;
        }
        
        .modal-title {
            font-size: 2.5rem;
            margin-bottom: 20px;
        }
        
        .modal-info {
            display: flex;
            margin-bottom: 20px;
        }
        
        .modal-rating {
            color: #46d369;
            font-weight: bold;
            margin-right: 15px;
        }
        
        .modal-year, .modal-seasons {
            margin-right: 15px;
        }
        
        .modal-description {
            margin-bottom: 30px;
            line-height: 1.6;
        }
        
        .seasons-container {
            margin-top: 30px;
        }
        
        .season-title {
            font-size: 1.5rem;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #333;
        }
        
        .episodes-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .episode-card {
            background-color: #2f2f2f;
            border-radius: 4px;
            overflow: hidden;
            transition: transform 0.3s;
            cursor: pointer;
        }
        
        .episode-card:hover {
            transform: scale(1.05);
        }
        
        .episode-image {
            width: 100%;
            height: 120px;
            background-size: cover;
            background-position: center;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #aaa;
            position: relative;
        }
        
        /* CORRECCIÓN: Eliminar el cuadrito "Ep1, Ep2" en episodios JSON */
        .episode-image .episode-number-overlay {
            display: none;
        }
        
        .episode-info {
            padding: 10px;
        }
        
        .episode-number {
            font-size: 0.9rem;
            color: #aaa;
            margin-bottom: 5px;
        }
        
        .episode-name {
            font-size: 1rem;
            font-weight: bold;
        }
        
        /* Sección Mi Lista */
        #mylist-section {
            display: none;
            padding: 120px 50px 50px;
            min-height: 100vh;
        }
        
        #mylist-back {
            background: none;
            color: #fff;
            font-size: 1rem;
            margin-bottom: 20px;
            cursor: pointer;
            padding: 10px;
            border: 1px solid #333;
            border-radius: 4px;
            transition: background 0.3s;
        }
        
        #mylist-back:hover {
            background: #333;
        }
        
        /* CORRECCIÓN: Botón de cambio de vista en Mi Lista a la derecha */
        .view-toggle {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 15px;
        }
        
        /* Reproductor de video mejorado */
        .video-player {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #000;
            z-index: 3000;
        }
        
        .video-container {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            position: relative;
        }
        
        .video-player video, .video-player iframe {
            width: 100%;
            height: 100%;
            object-fit: contain;
            border: none;
        }
        
        .video-title {
            position: absolute;
            top: 20px;
            left: 20px;
            color: white;
            font-size: 1.2rem;
            background-color: rgba(0, 0, 0, 0.7);
            padding: 5px 10px;
            border-radius: 4px;
            transition: opacity 0.3s;
        }
        
        .video-title.hidden {
            opacity: 0;
        }
        
        .video-controls {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            padding: 20px;
            background: linear-gradient(to top, rgba(0,0,0,0.9), transparent);
            transition: opacity 0.3s;
        }
        
        .video-controls.hidden {
            opacity: 0;
        }
        
        .controls-top {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .video-controls-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .video-controls-right {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-left: auto;
        }
        
        .control-button {
            background: none;
            border: none;
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            transition: background-color 0.3s;
        }
        
        .control-button:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        .progress-container {
            width: 100%;
            height: 5px;
            background-color: rgba(255, 255, 255, 0.3);
            border-radius: 3px;
            cursor: pointer;
            position: relative;
        }
        
        .progress-fill {
            height: 100%;
            background-color: #e50914;
            border-radius: 3px;
            width: 0%;
            position: relative;
        }
        
        .progress-buffered {
            position: absolute;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
        }
        
        .time-display {
            color: white;
            font-size: 0.9rem;
            min-width: 100px;
        }
        
        .volume-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .volume-slider {
            width: 80px;
            height: 5px;
            background-color: rgba(255, 255, 255, 0.3);
            border-radius: 3px;
            cursor: pointer;
            position: relative;
        }
        
        .volume-fill {
            height: 100%;
            background-color: #fff;
            border-radius: 3px;
            width: 100%;
        }
        
        .video-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            cursor: pointer;
            z-index: 10;
            transition: opacity 0.3s;
        }
        
        .video-close.hidden {
            opacity: 0;
        }
        
        /* Controles simplificados para iframe */
        .iframe-controls {
            position: absolute;
            bottom: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
            transition: opacity 0.3s;
        }
        
        .iframe-controls.hidden {
            opacity: 0;
        }
        
        /* Footer */
        .footer {
            padding: 50px;
            color: #808080;
        }
        
        .social-links {
            display: flex;
            margin-bottom: 20px;
        }
        
        .social-links a {
            margin-right: 15px;
            font-size: 1.5rem;
        }
        
        .footer-links {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .footer-links a {
            font-size: 13px;
        }
        
        .footer-links a:hover {
            text-decoration: underline;
        }
        
        .service-code {
            border: 1px solid #808080;
            padding: 6px;
            background: transparent;
            color: #808080;
            margin-bottom: 20px;
            font-size: 13px;
        }
        
        .copyright {
            font-size: 11px;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .header {
                padding: 20px;
            }
            
            .nav-links {
                display: none;
            }
            
            .banner {
                height: 60vh;
                padding: 0 20px;
            }
            
            .banner-content {
                max-width: 100%;
            }
            
            .banner-title {
                font-size: 2rem;
            }
            
            .content-section {
                padding: 0 20px;
                margin-bottom: 20px;
            }
            
            .carousel-item {
                min-width: calc(33.33% - 4px);
            }
            
            .carousel-item img {
                height: 300px;
            }
            
            .grid-view {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            }
            
            .horizontal-item {
                flex-direction: column;
            }
            
            .horizontal-item-image {
                width: 100%;
                height: 200px;
            }
            
            .episodes-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            }
            
            .footer-links {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .volume-slider {
                width: 60px;
            }

            .profile-menu {
                right: 20px;
            }

            .search-input.show {
                width: 150px;
                right: 70px;
            }

            .search-page {
                padding: 100px 20px 20px;
            }

            .search-results-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
                gap: 15px;
            }

            #mylist-section {
                padding: 100px 20px 20px;
            }
        }
    </style>
</head>
<body>
    <!-- Input oculto para selección de archivos M3U y JSON -->
    <input type="file" id="m3u-files" multiple accept=".m3u,.m3u8,.json" style="display: none;">

    <!-- Header -->
    <header class="header">
        <div class="nav-left">
            <a href="#" class="logo">
                <span>NefliClon</span>
            </a>
            <ul class="nav-links">
                <li><a href="#" onclick="selectM3UFiles()">Subir M3U</a></li>
                <li><a href="#" onclick="showHome()">Inicio</a></li>
                <li><a href="#" onclick="showSeries()">Series</a></li>
                <li><a href="#" onclick="showMovies()">Películas</a></li>
                <li><a href="#" onclick="showHome()">Novedades populares</a></li>
                <li><a href="#" onclick="showMyList()">Mi lista</a></li>
            </ul>
        </div>
        <div class="nav-right">
            <div class="search-icon" id="search-button">🔍</div>
            <input type="text" class="search-input" id="search-input" placeholder="Buscar series o películas">
            <div class="notifications">🔔</div>
            <div class="profile" id="profile-button">👤</div>
        </div>

        <!-- Menú desplegable del perfil -->
        <div class="profile-menu" id="profile-menu">
            <div class="profile-menu-item" onclick="clearAllContent()">🗑️ Limpiar todo el contenido</div>
        </div>
    </header>

    <!-- Página de búsqueda -->
    <section class="search-page" id="search-page">
        <div class="search-header">
            <h1 class="search-title" id="search-title">Resultados de búsqueda</h1>
            <div class="search-results-count" id="search-results-count">0 resultados encontrados</div>
        </div>
        <div class="search-results-grid" id="search-results">
            <!-- Los resultados de búsqueda aparecerán aquí -->
        </div>
        <div class="no-results" id="no-results" style="display: none;">
            No se encontraron resultados para tu búsqueda.
        </div>
    </section>

    <!-- Banner principal -->
    <section class="banner" id="banner-section">
        <div class="banner-content">
            <h1 class="banner-title" id="banner-title">Bienvenido a NefliClon</h1>
            <p class="banner-description" id="banner-description">Carga tus archivos M3U o JSON para comenzar a ver tu contenido favorito.</p>
            <div class="banner-buttons">
                <button class="banner-button play-button" id="banner-play">▶ Reproducir</button>
                <button class="banner-button info-button" id="banner-info">ⓘ Más información</button>
            </div>
        </div>
    </section>

    <!-- Sección de Series -->
    <section class="content-section" id="series-section">
        <h2 class="section-title">Tus series</h2>
        
        <!-- Botón de cambio de vista para series -->
        <div class="view-toggle-section" id="series-view-toggle">
            <button class="view-toggle-button" id="series-view-button">Cambiar a vista cuadrícula</button>
        </div>
        
        <!-- Vista carrusel (cuadrícula) -->
        <div class="carousel" id="series-carousel-container">
            <div class="carousel-container" id="series-carousel">
                <!-- Las series cargadas desde M3U aparecerán aquí en formato cuadrícula -->
            </div>
            <div class="carousel-nav prev" onclick="moveCarousel('series-carousel', -1)">‹</div>
            <div class="carousel-nav next" onclick="moveCarousel('series-carousel', 1)">›</div>
        </div>
        
        <!-- Vista cuadrícula para series -->
        <div class="grid-view" id="series-grid">
            <!-- Las series cargadas aparecerán aquí en formato cuadrícula -->
        </div>
    </section>

    <!-- Sección de Películas -->
    <section class="content-section" id="movies-section">
        <h2 class="section-title">Tus películas</h2>
        
        <!-- Botón de cambio de vista para películas -->
        <div class="view-toggle-section" id="movies-view-toggle">
            <button class="view-toggle-button" id="movies-view-button">Cambiar a vista cuadrícula</button>
        </div>
        
        <!-- Vista carrusel (cuadrícula) -->
        <div class="carousel" id="movies-carousel-container">
            <div class="carousel-container" id="movies-carousel">
                <!-- Las películas cargadas desde JSON aparecerán aquí en formato cuadrícula -->
            </div>
            <div class="carousel-nav prev" onclick="moveCarousel('movies-carousel', -1)">‹</div>
            <div class="carousel-nav next" onclick="moveCarousel('movies-carousel', 1)">›</div>
        </div>
        
        <!-- Vista cuadrícula para películas -->
        <div class="grid-view" id="movies-grid">
            <!-- Las películas cargadas aparecerán aquí en formato cuadrícula -->
        </div>
    </section>

    <section class="content-section" id="continue-section">
        <h2 class="section-title">Continuar viendo</h2>
        <div class="carousel">
            <div class="carousel-container" id="continue-carousel">
                <!-- Elementos del carrusel generados con JS -->
            </div>
            <div class="carousel-nav prev" onclick="moveCarousel('continue-carousel', -1)">‹</div>
            <div class="carousel-nav next" onclick="moveCarousel('continue-carousel', 1)">›</div>
        </div>
    </section>

    <!-- Sección Mi Lista -->
    <section id="mylist-section">
        <button id="mylist-back" onclick="showHome()">← Volver al inicio</button>
        <!-- CORRECCIÓN: Botón de cambio de vista en Mi Lista a la derecha -->
        <div class="view-toggle">
            <button class="view-toggle-button" id="view-toggle">Cambiar a vista cuadrícula</button>
        </div>
        <h2 class="section-title">Mi lista</h2>
        
        <!-- Vista horizontal (por defecto en Mi Lista) -->
        <div class="horizontal-list" id="mylist-horizontal">
            <!-- Las series en Mi Lista aparecerán aquí en formato horizontal -->
        </div>
        
        <!-- Vista carrusel (cuadrícula) -->
        <div class="carousel" id="mylist-carousel-container">
            <div class="carousel-container" id="mylist-carousel">
                <!-- Las series en Mi Lista aparecerán aquí en formato cuadrícula -->
            </div>
            <div class="carousel-nav prev" onclick="moveCarousel('mylist-carousel', -1)">‹</div>
            <div class="carousel-nav next" onclick="moveCarousel('mylist-carousel', 1)">›</div>
        </div>
    </section>

    <!-- Modal de detalles de serie -->
    <div class="modal" id="series-modal">
        <div class="modal-content">
            <div class="modal-header" id="modal-header">
                <div class="modal-close" id="modal-close">×</div>
            </div>
            <div class="modal-body">
                <h2 class="modal-title" id="modal-title">Título de la serie</h2>
                <div class="modal-info">
                    <span class="modal-rating" id="modal-rating">96% de coincidencia</span>
                    <span class="modal-year" id="modal-year">2024</span>
                    <span class="modal-seasons" id="modal-seasons">2 Temporadas</span>
                </div>
                <p class="modal-description" id="modal-description">Descripción de la serie.</p>
                <div class="banner-buttons">
                    <button class="banner-button play-button" id="modal-play">▶ Reproducir</button>
                    <button class="banner-button info-button" id="mylist-button">+ Mi lista</button>
                </div>
                
                <div class="seasons-container" id="seasons-container">
                    <!-- Las temporadas y episodios se cargarán aquí -->
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de detalles de película -->
    <div class="modal" id="movie-modal">
        <div class="modal-content">
            <div class="modal-header" id="movie-modal-header">
                <div class="modal-close" id="movie-modal-close">×</div>
            </div>
            <div class="modal-body">
                <h2 class="modal-title" id="movie-modal-title">Título de la película</h2>
                <div class="modal-info">
                    <span class="modal-rating" id="movie-modal-rating">96% de coincidencia</span>
                    <span class="modal-year" id="movie-modal-year">2024</span>
                </div>
                <p class="modal-description" id="movie-modal-description">Descripción de la película.</p>
                <div class="banner-buttons">
                    <button class="banner-button play-button" id="movie-modal-play">▶ Reproducir</button>
                    <button class="banner-button info-button" id="movie-mylist-button">+ Mi lista</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Reproductor de video mejorado -->
    <div class="video-player" id="video-player">
        <div class="video-container">
            <div class="video-title" id="video-title">Título del episodio</div>
            <video id="video-element"></video>
            <iframe id="video-iframe" style="display:none; width:100%; height:100%; border:none;"></iframe>
            
            <!-- Controles para video normal -->
            <div class="video-controls" id="video-controls">
                <div class="progress-container" id="progress-container">
                    <div class="progress-buffered" id="progress-buffered"></div>
                    <div class="progress-fill" id="progress-fill"></div>
                </div>
                <div class="controls-top">
                    <div class="video-controls-left">
                        <button class="control-button" id="play-pause-btn">⏸️</button>
                        <button class="control-button" id="backward-btn">⏪</button>
                        <button class="control-button" id="forward-btn">⏩</button>
                        <div class="volume-container">
                            <button class="control-button" id="volume-btn">🔊</button>
                            <div class="volume-slider" id="volume-slider">
                                <div class="volume-fill" id="volume-fill"></div>
                            </div>
                        </div>
                        <div class="time-display">
                            <span id="current-time">0:00</span> / <span id="duration">0:00</span>
                        </div>
                    </div>
                    <div class="video-controls-right">
                        <button class="control-button" id="speed-btn">1x</button>
                        <button class="control-button" id="fullscreen-btn">⛶</button>
                    </div>
                </div>
            </div>
            
            <!-- Controles simplificados para iframe -->
            <div class="iframe-controls" id="iframe-controls">
                <button class="control-button" id="iframe-fullscreen-btn">⛶</button>
            </div>
            
            <div class="video-close" id="video-close">×</div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="social-links">
            <a href="#">📘</a>
            <a href="#">🐦</a>
            <a href="#">📷</a>
        </div>
        <div class="footer-links">
            <a href="#">Audio y subtítulos</a>
            <a href="#">Zona de prensa</a>
            <a href="#">Privacidad</a>
            <a href="#">Contáctanos</a>
            <a href="#">Descripción de audio</a>
            <a href="#">Relaciones con inversionistas</a>
            <a href="#">Avisos legales</a>
            <a href="#">Centro de ayuda</a>
            <a href="#">Empleo</a>
            <a href="#">Preferencias de cookies</a>
            <a href="#">Tarjetas de regalo</a>
            <a href="#">Términos de uso</a>
            <a href="#">Información corporativa</a>
        </div>
        <button class="service-code">Código de servicio</button>
        <div class="copyright">© 1997-2025 NefliClon, Inc.</div>
    </footer>

    <script>
        // Variables globales
        let seriesData = [];
        let moviesData = [];
        let myList = [];
        let currentSeries = null;
        let currentMovie = null;
        let currentBannerSeries = null;
        let currentVideo = null;
        let continueWatching = [];
        let playbackSpeed = 1;
        let currentView = 'horizontal';
        let isIframeMode = false;
        let controlsTimeout;
        let seriesViewMode = 'carousel';
        let moviesViewMode = 'carousel';
        let lastBannerType = null;
        let searchQuery = '';

        // Función para guardar datos en localStorage
        function saveData() {
            localStorage.setItem('nefliclon_series', JSON.stringify(seriesData));
            localStorage.setItem('nefliclon_movies', JSON.stringify(moviesData));
            localStorage.setItem('nefliclon_mylist', JSON.stringify(myList));
            localStorage.setItem('nefliclon_continue', JSON.stringify(continueWatching));
        }

        // Inicializar la aplicación
        document.addEventListener('DOMContentLoaded', function() {
            // Cargar desde localStorage
            const savedSeries = localStorage.getItem('nefliclon_series');
            if (savedSeries) {
                seriesData = JSON.parse(savedSeries);
                updateSeriesCarousel();
                updateSeriesGrid();
                updateMyListViews();
                updateBanner();
            }
            
            const savedMovies = localStorage.getItem('nefliclon_movies');
            if (savedMovies) {
                moviesData = JSON.parse(savedMovies);
                updateMoviesCarousel();
                updateMoviesGrid();
            }
            
            const savedMyList = localStorage.getItem('nefliclon_mylist');
            if (savedMyList) {
                myList = JSON.parse(savedMyList);
            }
            
            const savedContinue = localStorage.getItem('nefliclon_continue');
            if (savedContinue) {
                continueWatching = JSON.parse(savedContinue);
                updateContinueCarousel();
            }
            
            setupEventListeners();
            setupVideoControls();
            updateContinueCarousel();
            
            // Establecer vista por defecto en Mi Lista
            setMyListView(currentView);
            
            // Efecto de scroll en el header
            window.addEventListener('scroll', function() {
                const header = document.querySelector('.header');
                if (window.scrollY > 100) {
                    header.classList.add('scrolled');
                } else {
                    header.classList.remove('scrolled');
                }
            });
        });

        // Configurar event listeners
        function setupEventListeners() {
            const fileInput = document.getElementById('m3u-files');
            
            fileInput.addEventListener('change', function() {
                for (let f of Array.from(this.files)) {
                    if (f.name.endsWith('.m3u') || f.name.endsWith('.m3u8')) {
                        processM3UFile(f);
                    } else if (f.name.endsWith('.json')) {
                        processJSONFile(f);
                    }
                }
            });
            
            // Cerrar modales
            document.getElementById('modal-close').addEventListener('click', function() {
                document.getElementById('series-modal').style.display = 'none';
            });
            
            document.getElementById('movie-modal-close').addEventListener('click', function() {
                document.getElementById('movie-modal').style.display = 'none';
            });
            
            // Cerrar reproductor de video
            document.getElementById('video-close').addEventListener('click', function() {
                closeVideoPlayer();
            });
            
            // Botón de cambio de vista (solo en Mi Lista)
            document.getElementById('view-toggle').addEventListener('click', function() {
                toggleMyListView();
            });

            // Botón de cambio de vista para series
            document.getElementById('series-view-button').addEventListener('click', function() {
                toggleSeriesView();
            });

            // Botón de cambio de vista para películas
            document.getElementById('movies-view-button').addEventListener('click', function() {
                toggleMoviesView();
            });

            // Menú del perfil
            document.getElementById('profile-button').addEventListener('click', function(event) {
                event.stopPropagation();
                const profileMenu = document.getElementById('profile-menu');
                profileMenu.classList.toggle('show');
            });

            // BUSCADOR - Configuración del sistema de búsqueda
            const searchButton = document.getElementById('search-button');
            const searchInput = document.getElementById('search-input');

            // Abrir/cerrar campo de búsqueda
            searchButton.addEventListener('click', function(event) {
                event.stopPropagation();
                searchInput.classList.toggle('show');
                if (searchInput.classList.contains('show')) {
                    searchInput.focus();
                } else {
                    searchInput.value = '';
                    // No ocultar la página de búsqueda si estamos mostrando contenido
                    if (document.getElementById('search-page').style.display === 'block' && searchQuery === '') {
                        // Mantener la página de búsqueda visible mostrando todo el contenido
                        showAllContent();
                    }
                }
            });

            // Cerrar buscador al hacer clic fuera - CORREGIDO
            document.addEventListener('click', function(event) {
                if (!searchButton.contains(event.target) && !searchInput.contains(event.target)) {
                    searchInput.classList.remove('show');
                    // NO ocultar la página de búsqueda si estamos mostrando contenido
                    // Solo ocultar si estamos en otra sección
                    if (searchInput.value === '' && document.getElementById('search-page').style.display === 'block') {
                        // Mantener la página de búsqueda visible mostrando todo el contenido
                        showAllContent();
                    }
                }
            });

            // Buscar al escribir
            searchInput.addEventListener('input', function() {
                searchQuery = this.value.trim();
                if (searchQuery.length > 0) {
                    performSearch(searchQuery);
                } else {
                    // Cuando se borra todo, mostrar todo el contenido
                    showAllContent();
                }
            });

            // Buscar al presionar Enter
            searchInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    searchQuery = this.value.trim();
                    if (searchQuery.length > 0) {
                        performSearch(searchQuery);
                    } else {
                        showAllContent();
                    }
                }
            });
        }

        // FUNCIONES DEL BUSCADOR

        // Mostrar todo el contenido cuando no hay búsqueda
        function showAllContent() {
            showSearchPage();
            const allContent = [...seriesData, ...moviesData];
            displayAllContent(allContent);
        }

        // Mostrar todo el contenido en la página de búsqueda
        function displayAllContent(content) {
            const resultsContainer = document.getElementById('search-results');
            const resultsCount = document.getElementById('search-results-count');
            const searchTitle = document.getElementById('search-title');
            const noResults = document.getElementById('no-results');

            resultsContainer.innerHTML = '';
            
            if (content.length === 0) {
                searchTitle.textContent = 'Todo';
                resultsCount.textContent = 'No hay contenido disponible';
                noResults.style.display = 'block';
                return;
            }

            searchTitle.textContent = 'Todo';
            resultsCount.textContent = `Total: ${content.length} elementos (${seriesData.length} series + ${moviesData.length} películas)`;
            noResults.style.display = 'none';

            content.forEach(item => {
                const resultItem = document.createElement('div');
                resultItem.className = `search-result-item ${myList.some(m => m.title === item.title && m.type === item.type) ? 'in-mylist' : ''}`;
                
                resultItem.addEventListener('click', function() {
                    if (item.type === 'series') {
                        openSeriesModal(item);
                    } else {
                        openMovieModal(item);
                    }
                });

                const img = document.createElement('img');
                img.src = item.image;
                img.alt = item.title;
                img.onerror = function() {
                    this.src = createPlaceholderImage(item.title);
                };

                const info = document.createElement('div');
                info.className = 'search-result-info';

                const title = document.createElement('div');
                title.className = 'search-result-title';
                title.textContent = item.title;

                const type = document.createElement('div');
                type.className = 'search-result-type';
                type.textContent = item.type === 'series' ? 'Serie' : 'Película';

                info.appendChild(title);
                info.appendChild(type);
                resultItem.appendChild(img);
                resultItem.appendChild(info);
                resultsContainer.appendChild(resultItem);
            });
        }

        // Realizar búsqueda
        function performSearch(query) {
            showSearchPage();
            const results = searchContent(query);
            displaySearchResults(results, query);
        }

        // Buscar en el contenido
        function searchContent(query) {
            const searchTerm = query.toLowerCase();
            const results = [];

            // Buscar en series
            seriesData.forEach(series => {
                if (series.title.toLowerCase().includes(searchTerm) || 
                    series.description.toLowerCase().includes(searchTerm)) {
                    results.push({
                        ...series,
                        searchType: 'series'
                    });
                }
            });

            // Buscar en películas
            moviesData.forEach(movie => {
                if (movie.title.toLowerCase().includes(searchTerm) || 
                    movie.description.toLowerCase().includes(searchTerm)) {
                    results.push({
                        ...movie,
                        searchType: 'movie'
                    });
                }
            });

            return results;
        }

        // Mostrar resultados de búsqueda
        function displaySearchResults(results, query) {
            const resultsContainer = document.getElementById('search-results');
            const resultsCount = document.getElementById('search-results-count');
            const searchTitle = document.getElementById('search-title');
            const noResults = document.getElementById('no-results');

            resultsContainer.innerHTML = '';
            
            if (results.length === 0) {
                searchTitle.textContent = 'Resultados de búsqueda';
                resultsCount.textContent = `No se encontraron resultados para "${query}"`;
                noResults.style.display = 'block';
                return;
            }

            searchTitle.textContent = 'Resultados de búsqueda';
            resultsCount.textContent = `${results.length} resultado${results.length > 1 ? 's' : ''} para "${query}"`;
            noResults.style.display = 'none';

            results.forEach(item => {
                const resultItem = document.createElement('div');
                resultItem.className = `search-result-item ${myList.some(m => m.title === item.title && m.type === item.searchType) ? 'in-mylist' : ''}`;
                
                resultItem.addEventListener('click', function() {
                    if (item.searchType === 'series') {
                        openSeriesModal(item);
                    } else {
                        openMovieModal(item);
                    }
                });

                const img = document.createElement('img');
                img.src = item.image;
                img.alt = item.title;
                img.onerror = function() {
                    this.src = createPlaceholderImage(item.title);
                };

                const info = document.createElement('div');
                info.className = 'search-result-info';

                const title = document.createElement('div');
                title.className = 'search-result-title';
                title.textContent = item.title;

                const type = document.createElement('div');
                type.className = 'search-result-type';
                type.textContent = item.searchType === 'series' ? 'Serie' : 'Película';

                info.appendChild(title);
                info.appendChild(type);
                resultItem.appendChild(img);
                resultItem.appendChild(info);
                resultsContainer.appendChild(resultItem);
            });
        }

        // Mostrar página de búsqueda
        function showSearchPage() {
            // Ocultar todas las demás secciones
            hideAllSections();
            // Mostrar página de búsqueda
            document.getElementById('search-page').style.display = 'block';
        }

        // Ocultar página de búsqueda
        function hideSearchPage() {
            document.getElementById('search-page').style.display = 'none';
        }

        // FUNCIONES CORREGIDAS PARA NAVEGACIÓN

        // Ocultar todas las secciones
        function hideAllSections() {
            document.getElementById('banner-section').style.display = 'none';
            document.getElementById('series-section').style.display = 'none';
            document.getElementById('movies-section').style.display = 'none';
            document.getElementById('continue-section').style.display = 'none';
            document.getElementById('mylist-section').style.display = 'none';
            document.getElementById('search-page').style.display = 'none';
        }

        // Mostrar página principal
        function showHome() {
            hideAllSections();
            document.getElementById('banner-section').style.display = 'flex';
            document.getElementById('series-section').style.display = 'block';
            document.getElementById('movies-section').style.display = 'block';
            document.getElementById('continue-section').style.display = 'block';
            
            // Ocultar botones de cambio de vista en el inicio
            document.getElementById('series-view-toggle').style.display = 'none';
            document.getElementById('movies-view-toggle').style.display = 'none';
            
            // Restablecer vista por defecto (carrusel)
            setSeriesView('carousel');
            setMoviesView('carousel');
            
            updateSeriesCarousel();
            updateSeriesGrid();
            updateMoviesCarousel();
            updateMoviesGrid();
            updateContinueCarousel();
        }

        // Mostrar solo series
        function showSeries() {
            hideAllSections();
            document.getElementById('banner-section').style.display = 'flex';
            document.getElementById('series-section').style.display = 'block';
            document.getElementById('continue-section').style.display = 'block';
            
            // Mostrar botón de cambio de vista solo para series
            document.getElementById('series-view-toggle').style.display = 'flex';
            document.getElementById('movies-view-toggle').style.display = 'none';
            
            updateSeriesCarousel();
            updateSeriesGrid();
            updateContinueCarousel();
        }

        // Mostrar solo películas
        function showMovies() {
            hideAllSections();
            document.getElementById('banner-section').style.display = 'flex';
            document.getElementById('movies-section').style.display = 'block';
            document.getElementById('continue-section').style.display = 'block';
            
            // Mostrar botón de cambio de vista solo para películas
            document.getElementById('series-view-toggle').style.display = 'none';
            document.getElementById('movies-view-toggle').style.display = 'flex';
            
            updateMoviesCarousel();
            updateMoviesGrid();
            updateContinueCarousel();
        }

        // Mostrar Mi Lista
        function showMyList() {
            hideAllSections();
            document.getElementById('mylist-section').style.display = 'block';
            
            // Ocultar botones de cambio de vista en Mi Lista
            document.getElementById('series-view-toggle').style.display = 'none';
            document.getElementById('movies-view-toggle').style.display = 'none';
            
            updateMyListViews();
        }

        // Función para limpiar todo el contenido
        function clearAllContent() {
            if (confirm('¿Estás seguro de que quieres eliminar todo el contenido? Esta acción no se puede deshacer.')) {
                seriesData = [];
                moviesData = [];
                myList = [];
                continueWatching = [];
                
                localStorage.removeItem('nefliclon_series');
                localStorage.removeItem('nefliclon_movies');
                localStorage.removeItem('nefliclon_mylist');
                localStorage.removeItem('nefliclon_continue');
                
                updateSeriesCarousel();
                updateSeriesGrid();
                updateMoviesCarousel();
                updateMoviesGrid();
                updateMyListViews();
                updateContinueCarousel();
                updateBanner();
                
                document.getElementById('profile-menu').classList.remove('show');
                
                alert('Todo el contenido ha sido eliminado correctamente.');
            }
        }

        // Cambiar entre vistas en Mi Lista
        function toggleMyListView() {
            if (currentView === 'horizontal') {
                setMyListView('grid');
            } else {
                setMyListView('horizontal');
            }
        }

        // Establecer vista específica en Mi Lista
        function setMyListView(view) {
            currentView = view;
            const horizontalList = document.getElementById('mylist-horizontal');
            const carouselContainer = document.getElementById('mylist-carousel-container');
            const toggleButton = document.getElementById('view-toggle');
            
            if (view === 'horizontal') {
                horizontalList.style.display = 'flex';
                carouselContainer.style.display = 'none';
                toggleButton.textContent = 'Cambiar a vista cuadrícula';
            } else {
                horizontalList.style.display = 'none';
                carouselContainer.style.display = 'block';
                toggleButton.textContent = 'Cambiar a vista horizontal';
            }
        }

        // Cambiar entre vistas para series
        function toggleSeriesView() {
            if (seriesViewMode === 'carousel') {
                setSeriesView('grid');
            } else {
                setSeriesView('carousel');
            }
        }

        // Establecer vista específica para series
        function setSeriesView(view) {
            seriesViewMode = view;
            const carouselContainer = document.getElementById('series-carousel-container');
            const gridContainer = document.getElementById('series-grid');
            const toggleButton = document.getElementById('series-view-button');
            
            if (view === 'carousel') {
                carouselContainer.style.display = 'block';
                gridContainer.style.display = 'none';
                toggleButton.textContent = 'Cambiar a vista cuadrícula';
            } else {
                carouselContainer.style.display = 'none';
                gridContainer.style.display = 'grid';
                toggleButton.textContent = 'Cambiar a vista carrusel';
            }
        }

        // Cambiar entre vistas para películas
        function toggleMoviesView() {
            if (moviesViewMode === 'carousel') {
                setMoviesView('grid');
            } else {
                setMoviesView('carousel');
            }
        }

        // Establecer vista específica para películas
        function setMoviesView(view) {
            moviesViewMode = view;
            const carouselContainer = document.getElementById('movies-carousel-container');
            const gridContainer = document.getElementById('movies-grid');
            const toggleButton = document.getElementById('movies-view-button');
            
            if (view === 'carousel') {
                carouselContainer.style.display = 'block';
                gridContainer.style.display = 'none';
                toggleButton.textContent = 'Cambiar a vista cuadrícula';
            } else {
                carouselContainer.style.display = 'none';
                gridContainer.style.display = 'grid';
                toggleButton.textContent = 'Cambiar a vista carrusel';
            }
        }

        // Configurar controles del reproductor de video
        function setupVideoControls() {
            const video = document.getElementById('video-element');
            const playPauseBtn = document.getElementById('play-pause-btn');
            const backwardBtn = document.getElementById('backward-btn');
            const forwardBtn = document.getElementById('forward-btn');
            const progressContainer = document.getElementById('progress-container');
            const progressFill = document.getElementById('progress-fill');
            const progressBuffered = document.getElementById('progress-buffered');
            const currentTimeElement = document.getElementById('current-time');
            const durationElement = document.getElementById('duration');
            const volumeBtn = document.getElementById('volume-btn');
            const volumeSlider = document.getElementById('volume-slider');
            const volumeFill = document.getElementById('volume-fill');
            const speedBtn = document.getElementById('speed-btn');
            const fullscreenBtn = document.getElementById('fullscreen-btn');
            const iframeFullscreenBtn = document.getElementById('iframe-fullscreen-btn');
            const videoControls = document.getElementById('video-controls');
            const iframeControls = document.getElementById('iframe-controls');
            const videoTitle = document.getElementById('video-title');
            const videoClose = document.getElementById('video-close');
            
            // Mostrar/ocultar controles al mover el mouse
            document.getElementById('video-player').addEventListener('mousemove', function() {
                showVideoControls();
            });
            
            // Función para mostrar controles y programar su ocultación
            function showVideoControls() {
                if (isIframeMode) {
                    videoTitle.classList.remove('hidden');
                    videoClose.classList.remove('hidden');
                    iframeControls.classList.remove('hidden');
                    
                    clearTimeout(controlsTimeout);
                    controlsTimeout = setTimeout(() => {
                        videoTitle.classList.add('hidden');
                        videoClose.classList.add('hidden');
                        iframeControls.classList.add('hidden');
                    }, 3000);
                } else {
                    videoControls.classList.remove('hidden');
                    videoTitle.classList.remove('hidden');
                    videoClose.classList.remove('hidden');
                    
                    clearTimeout(controlsTimeout);
                    controlsTimeout = setTimeout(() => {
                        if (!video.paused) {
                            videoControls.classList.add('hidden');
                            videoTitle.classList.add('hidden');
                            videoClose.classList.add('hidden');
                        }
                    }, 3000);
                }
            }
            
            // Botón play/pause (solo para video, no para iframe)
            playPauseBtn.addEventListener('click', function() {
                if (!isIframeMode && !video.paused) {
                    video.pause();
                    playPauseBtn.innerHTML = '▶️';
                } else if (!isIframeMode) {
                    video.play();
                    playPauseBtn.innerHTML = '⏸️';
                }
                showVideoControls();
            });
            
            // Retroceder 10 segundos (solo para video)
            backwardBtn.addEventListener('click', function() {
                if (!isIframeMode) {
                    video.currentTime -= 10;
                }
                showVideoControls();
            });
            
            // Adelantar 10 segundos (solo para video)
            forwardBtn.addEventListener('click', function() {
                if (!isIframeMode) {
                    video.currentTime += 10;
                }
                showVideoControls();
            });
            
            // Control de volumen (solo para video)
            volumeBtn.addEventListener('click', function() {
                if (!isIframeMode) {
                    if (video.muted || video.volume === 0) {
                        video.muted = false;
                        video.volume = 1;
                        volumeFill.style.width = '100%';
                        volumeBtn.innerHTML = '🔊';
                    } else {
                        video.muted = true;
                        volumeFill.style.width = '0%';
                        volumeBtn.innerHTML = '🔇';
                    }
                }
                showVideoControls();
            });
            
            // Slider de volumen (solo para video)
            volumeSlider.addEventListener('click', function(e) {
                if (!isIframeMode) {
                    const rect = volumeSlider.getBoundingClientRect();
                    const percent = (e.clientX - rect.left) / rect.width;
                    video.volume = Math.max(0, Math.min(1, percent));
                    volumeFill.style.width = `${percent * 100}%`;
                    video.muted = false;
                    volumeBtn.innerHTML = video.volume === 0 ? '🔇' : '🔊';
                }
                showVideoControls();
            });
            
            // Control de velocidad (solo para video)
            speedBtn.addEventListener('click', function() {
                if (!isIframeMode) {
                    const speeds = [0.5, 0.75, 1, 1.25, 1.5, 2];
                    const currentIndex = speeds.indexOf(playbackSpeed);
                    const nextIndex = (currentIndex + 1) % speeds.length;
                    playbackSpeed = speeds[nextIndex];
                    video.playbackRate = playbackSpeed;
                    speedBtn.textContent = playbackSpeed + 'x';
                }
                showVideoControls();
            });
            
            // Botón de pantalla completa para video normal
            fullscreenBtn.addEventListener('click', function() {
                if (!document.fullscreenElement) {
                    document.getElementById('video-player').requestFullscreen().catch(err => {
                        console.log(`Error attempting to enable full-screen mode: ${err.message}`);
                    });
                } else {
                    document.exitFullscreen();
                }
                showVideoControls();
            });
            
            // Botón de pantalla completa para iframe
            iframeFullscreenBtn.addEventListener('click', function() {
                if (!document.fullscreenElement) {
                    document.getElementById('video-player').requestFullscreen().catch(err => {
                        console.log(`Error attempting to enable full-screen mode: ${err.message}`);
                    });
                } else {
                    document.exitFullscreen();
                }
                showVideoControls();
            });
            
            // Actualizar progreso (solo para video)
            video.addEventListener('timeupdate', function() {
                if (!isIframeMode) {
                    const percent = (video.currentTime / video.duration) * 100;
                    progressFill.style.width = `${percent}%`;
                    
                    currentTimeElement.textContent = formatTime(video.currentTime);
                    durationElement.textContent = formatTime(video.duration);
                }
            });
            
            // Actualizar buffer (solo para video)
            video.addEventListener('progress', function() {
                if (!isIframeMode && video.buffered.length > 0) {
                    const bufferedEnd = video.buffered.end(video.buffered.length - 1);
                    const duration = video.duration;
                    if (duration > 0) {
                        progressBuffered.style.width = `${(bufferedEnd / duration) * 100}%`;
                    }
                }
            });
            
            // Click en la barra de progreso (solo para video)
            progressContainer.addEventListener('click', function(e) {
                if (!isIframeMode) {
                    const rect = progressContainer.getBoundingClientRect();
                    const percent = (e.clientX - rect.left) / rect.width;
                    video.currentTime = percent * video.duration;
                }
                showVideoControls();
            });
            
            // Eventos de video (solo para video)
            video.addEventListener('play', function() {
                if (!isIframeMode) {
                    playPauseBtn.innerHTML = '⏸️';
                }
            });
            
            video.addEventListener('pause', function() {
                if (!isIframeMode) {
                    playPauseBtn.innerHTML = '▶️';
                }
            });
            
            // Eventos de teclado
            document.addEventListener('keydown', function(e) {
                if (document.getElementById('video-player').style.display === 'block') {
                    switch(e.key) {
                        case ' ':
                        case 'k':
                            if (!isIframeMode) {
                                e.preventDefault();
                                playPauseBtn.click();
                            }
                            break;
                        case 'f':
                            e.preventDefault();
                            if (isIframeMode) {
                                iframeFullscreenBtn.click();
                            } else {
                                fullscreenBtn.click();
                            }
                            break;
                        case 'm':
                            if (!isIframeMode) {
                                e.preventDefault();
                                volumeBtn.click();
                            }
                            break;
                        case 'ArrowLeft':
                            if (!isIframeMode) {
                                e.preventDefault();
                                backwardBtn.click();
                            }
                            break;
                        case 'ArrowRight':
                            if (!isIframeMode) {
                                e.preventDefault();
                                forwardBtn.click();
                            }
                            break;
                        case 'ArrowUp':
                            if (!isIframeMode) {
                                e.preventDefault();
                                video.volume = Math.min(1, video.volume + 0.1);
                                volumeFill.style.width = `${video.volume * 100}%`;
                            }
                            break;
                        case 'ArrowDown':
                            if (!isIframeMode) {
                                e.preventDefault();
                                video.volume = Math.max(0, video.volume - 0.1);
                                volumeFill.style.width = `${video.volume * 100}%`;
                            }
                            break;
                    }
                    showVideoControls();
                }
            });
        }

        // Formatear tiempo en MM:SS o HH:MM:SS
        function formatTime(seconds) {
            if (isNaN(seconds)) return '0:00';
            
            const hours = Math.floor(seconds / 3600);
            const mins = Math.floor((seconds % 3600) / 60);
            const secs = Math.floor(seconds % 60);
            
            if (hours > 0) {
                return `${hours}:${mins < 10 ? '0' : ''}${mins}:${secs < 10 ? '0' : ''}${secs}`;
            } else {
                return `${mins}:${secs < 10 ? '0' : ''}${secs}`;
            }
        }

        // Función para seleccionar archivos M3U
        function selectM3UFiles() {
            document.getElementById('m3u-files').click();
        }

        // Procesar archivo M3U
        function processM3UFile(file) {
            const reader = new FileReader();
            
            reader.onload = function(e) {
                const content = e.target.result;
                const series = parseM3UContent(content, file.name);
                if (series && series.seasons) {
                    const existingIndex = seriesData.findIndex(s => s.title === series.title);
                    if (existingIndex > -1) {
                        seriesData[existingIndex] = series;
                    } else {
                        seriesData.push(series);
                    }
                    updateSeriesCarousel();
                    updateSeriesGrid();
                    updateMyListViews();
                    updateBanner();
                    updateContinueCarousel();
                    saveData();
                }
            };
            
            reader.readAsText(file);
        }

        // Procesar archivo JSON
        function processJSONFile(file) {
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const content = JSON.parse(e.target.result);
                    const items = parseJSONContent(content, file.name);
                    if (items && items.length > 0) {
                        items.forEach(item => {
                            if (item.type === 'series') {
                                const existingIndex = seriesData.findIndex(s => s.title === item.title);
                                if (existingIndex > -1) {
                                    seriesData[existingIndex] = item;
                                } else {
                                    seriesData.push(item);
                                }
                            } else {
                                const existingIndex = moviesData.findIndex(m => m.title === item.title);
                                if (existingIndex > -1) {
                                    moviesData[existingIndex] = item;
                                } else {
                                    moviesData.push(item);
                                }
                            }
                        });
                        updateSeriesCarousel();
                        updateSeriesGrid();
                        updateMoviesCarousel();
                        updateMoviesGrid();
                        updateMyListViews();
                        updateBanner();
                        updateContinueCarousel();
                        saveData();
                    }
                } catch (error) {
                    console.error('Error al procesar JSON:', error);
                }
            };
            
            reader.readAsText(file);
        }

        // Parsear contenido JSON
        function parseJSONContent(content, fileName) {
            if (!Array.isArray(content)) {
                console.error('El contenido JSON debe ser un array');
                return [];
            }
            
            return content.map(item => {
                let type = 'movie';
                let seasons = {};
                
                if (item.type) {
                    type = item.type;
                } else if (Object.keys(item).some(key => key.startsWith('cap'))) {
                    type = 'series';
                    for (const key in item) {
                        if (key.startsWith('cap')) {
                            const match = key.match(/cap(\d+)s(\d+)/i);
                            if (match) {
                                const episodeNum = parseInt(match[1]);
                                const seasonNum = parseInt(match[2]);
                                
                                if (!seasons[seasonNum]) {
                                    seasons[seasonNum] = [];
                                }
                                
                                seasons[seasonNum].push({
                                    title: `Capítulo ${episodeNum}`,
                                    url: item[key],
                                    season: seasonNum,
                                    episode: episodeNum,
                                    cleanTitle: `Capítulo ${episodeNum}`,
                                    seriesImage: item.image
                                });
                            }
                        }
                    }
                } else if (item.video && !Object.keys(item).some(key => key.startsWith('cap'))) {
                    type = 'movie';
                }
                
                if (type === 'series') {
                    return {
                        title: item.title || 'Serie sin título',
                        image: item.image || createPlaceholderImage(item.title || 'Serie'),
                        description: item.description || `Serie: ${item.title || 'Sin título'}`,
                        seasons: seasons,
                        type: 'series',
                        source: 'json'
                    };
                } else {
                    return {
                        title: item.title || 'Película sin título',
                        image: item.image || createPlaceholderImage(item.title || 'Película'),
                        video: item.video,
                        description: item.description || `Película: ${item.title || 'Sin título'}`,
                        type: 'movie',
                        source: 'json'
                    };
                }
            });
        }

        // Parsear contenido M3U
        function parseM3UContent(content, fileName) {
            const lines = content.split('\n');
            let episodes = [];
            let firstLogo = '';
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                
                if (line.startsWith('#EXTINF:')) {
                    const urlLine = lines[i + 1] ? lines[i + 1].trim() : '';
                    
                    if (urlLine && !urlLine.startsWith('#')) {
                        let title = '';
                        let logo = '';
                        
                        const format1Match = line.match(/#EXTINF:[^,]*,(.+)$/);
                        if (format1Match) {
                            title = format1Match[1].trim();
                        }
                        
                        const logoMatch = line.match(/tvg-logo="([^"]+)"/);
                        if (logoMatch) {
                            logo = logoMatch[1];
                            if (!firstLogo) firstLogo = logo;
                        }
                        
                        title = title.replace(/[\[\]]/g, '').trim();
                        
                        if (title) {
                            episodes.push({
                                title: title,
                                logo: logo,
                                url: urlLine,
                                originalLine: line
                            });
                        }
                    }
                }
            }
            
            const seasons = organizeSeasonsFromEpisodes(episodes);
            const seriesTitle = extractSeriesTitle(fileName, episodes);
            
            return {
                title: seriesTitle,
                description: `Serie con ${episodes.length} episodios`,
                image: firstLogo || createPlaceholderImage(seriesTitle),
                seasons: seasons,
                totalEpisodes: episodes.length,
                type: 'series',
                source: 'm3u'
            };
        }

        // Organizar episodios en temporadas de manera inteligente
        function organizeSeasonsFromEpisodes(episodes) {
            const seasons = {};
            let currentSeason = 1;
            let episodeInSeason = 0;
            
            episodes.forEach((episode, index) => {
                const title = episode.title.toUpperCase();
                
                const seasonMarkers = [
                    /TEMPORADA\s*(\d+)/i,
                    /TEMP\s*(\d+)/i,
                    /T(\d+)/,
                    /S(\d+)/,
                    /SEASON\s*(\d+)/i,
                    /\s+(\d+)x\d+/
                ];
                
                let detectedSeason = null;
                for (const marker of seasonMarkers) {
                    const match = title.match(marker);
                    if (match) {
                        detectedSeason = parseInt(match[1]);
                        break;
                    }
                }
                
                if (detectedSeason && detectedSeason !== currentSeason) {
                    currentSeason = detectedSeason;
                    episodeInSeason = 0;
                }
                
                const episodeMarkers = [
                    /CAP[ÍI]?TULO?\s*(\d+)/i,
                    /CAP\s*(\d+)/i,
                    /EP[ISODIO]*\s*(\d+)/i,
                    /E(\d+)/,
                    /\d+x(\d+)/,
                    /\s+(\d+)\s*$/
                ];
                
                let detectedEpisode = null;
                for (const marker of episodeMarkers) {
                    const match = title.match(marker);
                    if (match) {
                        detectedEpisode = parseInt(match[1]);
                        break;
                    }
                }
                
                episodeInSeason++;
                const episodeNumber = detectedEpisode || episodeInSeason;
                
                if (!seasons[currentSeason]) {
                    seasons[currentSeason] = [];
                }
                
                seasons[currentSeason].push({
                    ...episode,
                    season: currentSeason,
                    episode: episodeNumber,
                    cleanTitle: cleanEpisodeTitle(episode.title)
                });
            });
            
            if (Object.keys(seasons).length === 0 && episodes.length > 0) {
                seasons[1] = episodes.map((ep, idx) => ({
                    ...ep,
                    season: 1,
                    episode: idx + 1,
                    cleanTitle: cleanEpisodeTitle(ep.title)
                }));
            }
            
            return seasons;
        }

        // Limpiar título de episodio
        function cleanEpisodeTitle(title) {
            let clean = title;
            
            clean = clean.replace(/^(TEMPORADA|TEMP|T|S)\s*\d+\s*/i, '');
            clean = clean.replace(/^(CAP[ÍI]?TULO?|CAP|EP[ISODIO]*|E)\s*\d+\s*/i, '');
            clean = clean.replace(/^\d+x\d+\s*[-:]?\s*/i, '');
            clean = clean.replace(/^\d+\s*[-:]?\s*/i, '');
            
            return clean.trim() || title;
        }

        // Extraer título de la serie
        function extractSeriesTitle(fileName, episodes) {
            let seriesTitle = fileName.replace(/\.m3u8?$/i, '').replace(/[_-]/g, ' ').trim();
            
            if (seriesTitle.toLowerCase() === 'playlist' || seriesTitle.toLowerCase() === 'lista' || !seriesTitle) {
                if (episodes.length > 0) {
                    const firstTitle = episodes[0].title;
                    const seriesMatch = firstTitle.match(/^([^-–]+?)(?:\s*[-–]|\s+(?:TEMPORADA|TEMP|T|S)\s*\d+)/i);
                    if (seriesMatch) {
                        seriesTitle = seriesMatch[1].trim();
                    }
                }
            }
            
            return seriesTitle || 'Serie sin título';
        }

        // Crear imagen placeholder
        function createPlaceholderImage(title) {
            const colors = ['#e50914', '#333', '#444', '#555', '#666'];
            const color = colors[Math.floor(Math.random() * colors.length)];
            return `data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='300' height='450' viewBox='0 0 300 450'><rect width='300' height='450' fill='${color}'/><text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' font-family='Arial' font-size='18' fill='%23fff'>${encodeURIComponent(title)}</text></svg>`;
        }

        // CORRECCIÓN: Sistema de banner mejorado para alternar equitativamente
        function updateBanner() {
            const allContent = [...seriesData, ...moviesData];
            
            if (allContent.length === 0) {
                document.getElementById('banner-title').textContent = 'Bienvenido a NefliClon';
                document.getElementById('banner-description').textContent = 'Carga tus archivos M3U o JSON para comenzar a ver tu contenido favorito.';
                document.getElementById('banner-play').onclick = function() {
                    alert('Primero carga algún contenido para reproducir');
                };
                document.getElementById('banner-info').onclick = function() {
                    alert('Primero carga algún contenido para ver más información');
                };
                return;
            }
            
            const series = allContent.filter(item => item.type === 'series');
            const movies = allContent.filter(item => item.type === 'movie');
            
            let selectedContent = null;
            
            if (lastBannerType === 'series' && movies.length > 0) {
                const randomIndex = Math.floor(Math.random() * movies.length);
                selectedContent = movies[randomIndex];
                lastBannerType = 'movie';
            } else if (lastBannerType === 'movie' && series.length > 0) {
                const randomIndex = Math.floor(Math.random() * series.length);
                selectedContent = series[randomIndex];
                lastBannerType = 'series';
            } else {
                if (series.length > 0 && movies.length > 0) {
                    const useSeries = Math.random() > 0.5;
                    const sourceArray = useSeries ? series : movies;
                    const randomIndex = Math.floor(Math.random() * sourceArray.length);
                    selectedContent = sourceArray[randomIndex];
                    lastBannerType = useSeries ? 'series' : 'movie';
                } else if (series.length > 0) {
                    const randomIndex = Math.floor(Math.random() * series.length);
                    selectedContent = series[randomIndex];
                    lastBannerType = 'series';
                } else if (movies.length > 0) {
                    const randomIndex = Math.floor(Math.random() * movies.length);
                    selectedContent = movies[randomIndex];
                    lastBannerType = 'movie';
                }
            }
            
            currentBannerSeries = selectedContent;
            
            const banner = document.querySelector('.banner');
            const bannerTitle = document.getElementById('banner-title');
            const bannerDesc = document.getElementById('banner-description');
            
            bannerTitle.textContent = currentBannerSeries.title;
            bannerDesc.textContent = currentBannerSeries.description;
            
            if (currentBannerSeries.image && !currentBannerSeries.image.includes('svg')) {
                banner.style.background = `linear-gradient(to top, #141414, transparent 50%), linear-gradient(to right, #141414, transparent 30%), url('${currentBannerSeries.image}')`;
                banner.style.backgroundSize = 'cover';
                banner.style.backgroundPosition = 'center';
            } else {
                banner.style.background = `linear-gradient(to top, #141414, transparent 50%), linear-gradient(to right, #141414, transparent 30%), url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="1200" height="675" viewBox="0 0 1200 675"><rect width="1200" height="675" fill="%23222"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" font-family="Arial" font-size="24" fill="%23fff">${encodeURIComponent(currentBannerSeries.title)}</text></svg>')`;
            }
            
            document.getElementById('banner-play').onclick = function() {
                if (currentBannerSeries.type === 'series') {
                    playFirstEpisode(currentBannerSeries);
                } else {
                    playMovie(currentBannerSeries);
                }
            };
            
            document.getElementById('banner-info').onclick = function() {
                if (currentBannerSeries.type === 'series') {
                    openSeriesModal(currentBannerSeries);
                } else {
                    openMovieModal(currentBannerSeries);
                }
            };
        }

        // Reproducir primer episodio de una serie
        function playFirstEpisode(series) {
            const firstSeason = Object.keys(series.seasons).find(s => series.seasons[s] && series.seasons[s].length > 0);
            if (firstSeason && series.seasons[firstSeason].length > 0) {
                playEpisode(series.seasons[firstSeason][0], series.title);
            }
        }

        // Reproducir película
        function playMovie(movie) {
            const videoPlayer = document.getElementById('video-player');
            const videoElement = document.getElementById('video-element');
            const videoIframe = document.getElementById('video-iframe');
            const videoTitle = document.getElementById('video-title');
            const videoControls = document.getElementById('video-controls');
            const iframeControls = document.getElementById('iframe-controls');
            const videoClose = document.getElementById('video-close');
            
            currentVideo = {
                movie: movie
            };
            
            isIframeMode = true;
            videoElement.style.display = 'none';
            videoIframe.style.display = 'block';
            videoIframe.src = movie.video;
            videoTitle.textContent = movie.title;
            videoPlayer.style.display = 'block';
            
            videoControls.style.display = 'none';
            iframeControls.style.display = 'flex';
            videoClose.style.display = 'flex';
            
            videoTitle.classList.remove('hidden');
            videoClose.classList.remove('hidden');
            iframeControls.classList.remove('hidden');
            
            clearTimeout(controlsTimeout);
            controlsTimeout = setTimeout(() => {
                videoTitle.classList.add('hidden');
                videoClose.classList.add('hidden');
                iframeControls.classList.add('hidden');
            }, 3000);
            
            document.getElementById('movie-modal').style.display = 'none';
        }

        // Reproducir episodio - FUNCIÓN CORREGIDA
        function playEpisode(episode, seriesTitle, startTime = 0) {
            const videoPlayer = document.getElementById('video-player');
            const videoElement = document.getElementById('video-element');
            const videoIframe = document.getElementById('video-iframe');
            const videoTitle = document.getElementById('video-title');
            const videoControls = document.getElementById('video-controls');
            const iframeControls = document.getElementById('iframe-controls');
            const videoClose = document.getElementById('video-close');
            
            currentVideo = {
                episode: episode,
                seriesTitle: seriesTitle
            };

            const currentSeries = seriesData.find(s => s.title === seriesTitle);
            
            if (currentSeries && currentSeries.source === 'json') {
                isIframeMode = true;
                videoElement.style.display = 'none';
                videoIframe.style.display = 'block';
                videoIframe.src = episode.url;
                videoTitle.textContent = `${seriesTitle} - T${episode.season}E${episode.episode}: ${episode.cleanTitle || episode.title}`;
                videoPlayer.style.display = 'block';
                
                videoControls.style.display = 'none';
                iframeControls.style.display = 'flex';
                videoClose.style.display = 'flex';
                
                videoTitle.classList.remove('hidden');
                videoClose.classList.remove('hidden');
                iframeControls.classList.remove('hidden');
                
                clearTimeout(controlsTimeout);
                controlsTimeout = setTimeout(() => {
                    videoTitle.classList.add('hidden');
                    videoClose.classList.add('hidden');
                    iframeControls.classList.add('hidden');
                }, 3000);
            } else {
                isIframeMode = false;
                videoElement.style.display = 'block';
                videoIframe.style.display = 'none';
                videoElement.src = episode.url;
                videoTitle.textContent = `${seriesTitle} - T${episode.season}E${episode.episode}: ${episode.cleanTitle || episode.title}`;
                videoPlayer.style.display = 'block';
                videoControls.style.display = 'block';
                iframeControls.style.display = 'none';
                videoClose.style.display = 'flex';
                
                videoControls.classList.remove('hidden');
                videoTitle.classList.remove('hidden');
                videoClose.classList.remove('hidden');
                
                clearTimeout(controlsTimeout);
                controlsTimeout = setTimeout(() => {
                    if (!videoElement.paused) {
                        videoControls.classList.add('hidden');
                        videoTitle.classList.add('hidden');
                        videoClose.classList.add('hidden');
                    }
                }, 3000);
                
                if (startTime > 0) {
                    videoElement.currentTime = startTime;
                }
                
                videoElement.play();
                document.getElementById('play-pause-btn').innerHTML = '⏸️';
            }
            
            document.getElementById('series-modal').style.display = 'none';
        }

        // Actualizar carrusel de series
        function updateSeriesCarousel() {
            const carousel = document.getElementById('series-carousel');
            carousel.innerHTML = '';
            
            seriesData.forEach(series => {
                const item = document.createElement('div');
                item.className = `carousel-item ${myList.some(m => m.title === series.title && m.type === 'series') ? 'in-mylist' : ''}`;
                item.addEventListener('click', function() {
                    openSeriesModal(series);
                });
                
                const img = document.createElement('img');
                img.src = series.image;
                img.alt = series.title;
                img.onerror = function() {
                    this.src = createPlaceholderImage(series.title);
                };
                
                item.appendChild(img);
                carousel.appendChild(item);
            });
        }

        // Actualizar cuadrícula de series
        function updateSeriesGrid() {
            const grid = document.getElementById('series-grid');
            grid.innerHTML = '';
            
            seriesData.forEach(series => {
                const item = document.createElement('div');
                item.className = `grid-item ${myList.some(m => m.title === series.title && m.type === 'series') ? 'in-mylist' : ''}`;
                item.addEventListener('click', function() {
                    openSeriesModal(series);
                });
                
                const img = document.createElement('img');
                img.src = series.image;
                img.alt = series.title;
                img.onerror = function() {
                    this.src = createPlaceholderImage(series.title);
                };
                
                item.appendChild(img);
                grid.appendChild(item);
            });
        }

        // Actualizar carrusel de películas
        function updateMoviesCarousel() {
            const carousel = document.getElementById('movies-carousel');
            carousel.innerHTML = '';
            
            moviesData.forEach(movie => {
                const item = document.createElement('div');
                item.className = `carousel-item ${myList.some(m => m.title === movie.title && m.type === 'movie') ? 'in-mylist' : ''}`;
                item.addEventListener('click', function() {
                    openMovieModal(movie);
                });
                
                const img = document.createElement('img');
                img.src = movie.image;
                img.alt = movie.title;
                img.onerror = function() {
                    this.src = createPlaceholderImage(movie.title);
                };
                
                item.appendChild(img);
                carousel.appendChild(item);
            });
        }

        // Actualizar cuadrícula de películas
        function updateMoviesGrid() {
            const grid = document.getElementById('movies-grid');
            grid.innerHTML = '';
            
            moviesData.forEach(movie => {
                const item = document.createElement('div');
                item.className = `grid-item ${myList.some(m => m.title === movie.title && m.type === 'movie') ? 'in-mylist' : ''}`;
                item.addEventListener('click', function() {
                    openMovieModal(movie);
                });
                
                const img = document.createElement('img');
                img.src = movie.image;
                img.alt = movie.title;
                img.onerror = function() {
                    this.src = createPlaceholderImage(movie.title);
                };
                
                item.appendChild(img);
                grid.appendChild(item);
            });
        }

        // Actualizar vistas de Mi Lista
        function updateMyListViews() {
            updateMyListCarousel();
            updateMyListHorizontal();
        }

        // Actualizar carrusel de Mi Lista
        function updateMyListCarousel() {
            const carousel = document.getElementById('mylist-carousel');
            carousel.innerHTML = '';
            
            myList.forEach(item => {
                const itemEl = document.createElement('div');
                itemEl.className = 'carousel-item in-mylist';
                itemEl.addEventListener('click', function() {
                    if (item.type === 'series') {
                        openSeriesModal(item);
                    } else {
                        openMovieModal(item);
                    }
                });
                
                const img = document.createElement('img');
                img.src = item.image;
                img.alt = item.title;
                img.onerror = function() {
                    this.src = createPlaceholderImage(item.title);
                };
                
                itemEl.appendChild(img);
                carousel.appendChild(itemEl);
            });
        }

        // Actualizar lista horizontal de Mi Lista
        function updateMyListHorizontal() {
            const horizontalList = document.getElementById('mylist-horizontal');
            horizontalList.innerHTML = '';
            
            myList.forEach(item => {
                const itemEl = document.createElement('div');
                itemEl.className = 'horizontal-item in-mylist';
                itemEl.addEventListener('click', function() {
                    if (item.type === 'series') {
                        openSeriesModal(item);
                    } else {
                        openMovieModal(item);
                    }
                });
                
                const imageDiv = document.createElement('div');
                imageDiv.className = 'horizontal-item-image';
                imageDiv.style.backgroundImage = `url(${item.image})`;
                
                const contentDiv = document.createElement('div');
                contentDiv.className = 'horizontal-item-content';
                
                const title = document.createElement('h3');
                title.className = 'horizontal-item-title';
                title.textContent = item.title;
                
                const info = document.createElement('div');
                info.className = 'horizontal-item-info';
                
                const rating = document.createElement('span');
                rating.className = 'horizontal-item-rating';
                rating.textContent = '95% de coincidencia';
                
                const year = document.createElement('span');
                year.textContent = '2024';
                
                const typeInfo = document.createElement('span');
                typeInfo.textContent = item.type === 'series' ? `${Object.keys(item.seasons).length} Temporadas` : 'Película';
                
                info.appendChild(rating);
                info.appendChild(year);
                info.appendChild(typeInfo);
                
                const description = document.createElement('p');
                description.className = 'horizontal-item-description';
                description.textContent = item.description;
                
                const buttons = document.createElement('div');
                buttons.className = 'horizontal-item-buttons';
                
                const playButton = document.createElement('button');
                playButton.className = 'horizontal-item-button play-button';
                playButton.textContent = '▶ Reproducir';
                playButton.addEventListener('click', function(e) {
                    e.stopPropagation();
                    if (item.type === 'series') {
                        playFirstEpisode(item);
                    } else {
                        playMovie(item);
                    }
                });
                
                const removeButton = document.createElement('button');
                removeButton.className = 'horizontal-item-button info-button';
                removeButton.textContent = '✕ Quitar de Mi Lista';
                removeButton.addEventListener('click', function(e) {
                    e.stopPropagation();
                    removeFromMyList(item);
                });
                
                buttons.appendChild(playButton);
                buttons.appendChild(removeButton);
                
                contentDiv.appendChild(title);
                contentDiv.appendChild(info);
                contentDiv.appendChild(description);
                contentDiv.appendChild(buttons);
                
                itemEl.appendChild(imageDiv);
                itemEl.appendChild(contentDiv);
                
                horizontalList.appendChild(itemEl);
            });
        }

        // Agregar o actualizar item en continuar viendo (simplificado)
        function addToContinueWatching(item) {
            const existingIndex = continueWatching.findIndex(i => i.title === item.title && i.type === item.type);
            if (existingIndex > -1) {
                continueWatching[existingIndex].timestamp = Date.now();
            } else {
                continueWatching.unshift({
                    title: item.title,
                    image: item.image,
                    type: item.type,
                    progress: 30,
                    timestamp: Date.now()
                });
                if (continueWatching.length > 10) {
                    continueWatching = continueWatching.slice(0, 10);
                }
            }
            saveData();
            updateContinueCarousel();
        }

        // Actualizar carrusel continuar viendo
        function updateContinueCarousel() {
            const carousel = document.getElementById('continue-carousel');
            carousel.innerHTML = '';
            
            const sortedContinue = [...continueWatching].sort((a, b) => b.timestamp - a.timestamp);
            
            sortedContinue.forEach(item => {
                let contentItem;
                if (item.type === 'series') {
                    contentItem = seriesData.find(s => s.title === item.title);
                } else {
                    contentItem = moviesData.find(m => m.title === item.title);
                }
                
                if (contentItem) {
                    const itemEl = document.createElement('div');
                    itemEl.className = 'carousel-item';
                    itemEl.addEventListener('click', function() {
                        if (item.type === 'series') {
                            openSeriesModal(contentItem);
                        } else {
                            openMovieModal(contentItem);
                        }
                    });
                    
                    const img = document.createElement('img');
                    img.src = item.image || contentItem.image;
                    img.alt = item.title;
                    img.onerror = function() {
                        this.src = createPlaceholderImage(item.title);
                    };
                    
                    const progressWrapper = document.createElement('div');
                    progressWrapper.className = 'progress-bar-wrapper';
                    
                    const progressFill = document.createElement('div');
                    progressFill.className = 'progress-bar-fill';
                    progressFill.style.width = `${item.progress}%`;
                    
                    progressWrapper.appendChild(progressFill);
                    itemEl.appendChild(img);
                    itemEl.appendChild(progressWrapper);
                    carousel.appendChild(itemEl);
                }
            });
        }

        // Agregar a Mi Lista
        function addToMyList(item) {
            if (!myList.some(m => m.title === item.title && m.type === item.type)) {
                myList.push(item);
                saveData();
                updateSeriesCarousel();
                updateSeriesGrid();
                updateMoviesCarousel();
                updateMoviesGrid();
                updateMyListViews();
                
                if (item.type === 'series') {
                    document.getElementById('mylist-button').textContent = '✓ Mi lista';
                    document.getElementById('mylist-button').classList.add('play-button');
                    document.getElementById('mylist-button').classList.remove('info-button');
                } else {
                    document.getElementById('movie-mylist-button').textContent = '✓ Mi lista';
                    document.getElementById('movie-mylist-button').classList.add('play-button');
                    document.getElementById('movie-mylist-button').classList.remove('info-button');
                }
            }
        }

        // Quitar de Mi Lista
        function removeFromMyList(item) {
            const index = myList.findIndex(m => m.title === item.title && m.type === item.type);
            if (index > -1) {
                myList.splice(index, 1);
                saveData();
                updateSeriesCarousel();
                updateSeriesGrid();
                updateMoviesCarousel();
                updateMoviesGrid();
                updateMyListViews();
                
                if (item.type === 'series' && currentSeries && currentSeries.title === item.title) {
                    document.getElementById('mylist-button').textContent = '+ Mi lista';
                    document.getElementById('mylist-button').classList.remove('play-button');
                    document.getElementById('mylist-button').classList.add('info-button');
                } else if (item.type === 'movie' && currentMovie && currentMovie.title === item.title) {
                    document.getElementById('movie-mylist-button').textContent = '+ Mi lista';
                    document.getElementById('movie-mylist-button').classList.remove('play-button');
                    document.getElementById('movie-mylist-button').classList.add('info-button');
                }
            }
        }

        // CORRECCIÓN: Abrir modal de serie - ELIMINAR CUADRITO "Ep1, Ep2" EN EPISODIOS JSON
        function openSeriesModal(series) {
            currentSeries = series;
            addToContinueWatching(series);
            
            document.getElementById('modal-title').textContent = series.title;
            document.getElementById('modal-description').textContent = series.description;
            
            const modalHeader = document.getElementById('modal-header');
            if (series.image && !series.image.includes('svg')) {
                modalHeader.style.backgroundImage = `url(${series.image})`;
            } else {
                modalHeader.style.background = '#333';
            }
            
            const seasonsContainer = document.getElementById('seasons-container');
            seasonsContainer.innerHTML = '';
            
            let seasonCount = 0;
            for (const key in series.seasons) {
                if (series.seasons[key] && series.seasons[key].length > 0) seasonCount++;
            }
            document.getElementById('modal-seasons').textContent = `${seasonCount} Temporada${seasonCount > 1 ? 's' : ''}`;
            
            for (const seasonNum in series.seasons) {
                const season = series.seasons[seasonNum];
                if (season && season.length > 0) {
                    const seasonSection = document.createElement('div');
                    seasonSection.className = 'season-section';
                    
                    const seasonTitle = document.createElement('h3');
                    seasonTitle.className = 'season-title';
                    seasonTitle.textContent = `Temporada ${seasonNum}`;
                    seasonSection.appendChild(seasonTitle);
                    
                    const episodesGrid = document.createElement('div');
                    episodesGrid.className = 'episodes-grid';
                    
                    season.forEach(episode => {
                        const episodeCard = document.createElement('div');
                        episodeCard.className = 'episode-card';
                        episodeCard.addEventListener('click', function() {
                            playEpisode(episode, series.title);
                        });
                        
                        const episodeImage = document.createElement('div');
                        episodeImage.className = 'episode-image';
                        
                        if (series.source === 'json' && series.image && !series.image.includes('svg')) {
                            episodeImage.style.backgroundImage = `url(${series.image})`;
                        } else if (episode.logo && !episode.logo.includes('svg')) {
                            episodeImage.style.backgroundImage = `url(${episode.logo})`;
                        } else {
                            episodeImage.innerHTML = `<div>Ep ${episode.episode}</div>`;
                        }
                        
                        const episodeInfo = document.createElement('div');
                        episodeInfo.className = 'episode-info';
                        
                        const episodeNumber = document.createElement('div');
                        episodeNumber.className = 'episode-number';
                        episodeNumber.textContent = `Episodio ${episode.episode}`;
                        
                        const episodeName = document.createElement('div');
                        episodeName.className = 'episode-name';
                        episodeName.textContent = episode.cleanTitle || episode.title;
                        
                        episodeInfo.appendChild(episodeNumber);
                        episodeInfo.appendChild(episodeName);
                        
                        episodeCard.appendChild(episodeImage);
                        episodeCard.appendChild(episodeInfo);
                        
                        episodesGrid.appendChild(episodeCard);
                    });
                    
                    seasonSection.appendChild(episodesGrid);
                    seasonsContainer.appendChild(seasonSection);
                }
            }
            
            const mylistButton = document.getElementById('mylist-button');
            if (myList.some(m => m.title === series.title && m.type === 'series')) {
                mylistButton.textContent = '✓ Mi lista';
                mylistButton.classList.add('play-button');
                mylistButton.classList.remove('info-button');
                mylistButton.onclick = function() {
                    removeFromMyList(series);
                };
            } else {
                mylistButton.textContent = '+ Mi lista';
                mylistButton.classList.remove('play-button');
                mylistButton.classList.add('info-button');
                mylistButton.onclick = function() {
                    addToMyList(series);
                };
            }
            
            document.getElementById('series-modal').style.display = 'block';
            
            document.getElementById('modal-play').onclick = function() {
                playFirstEpisode(series);
            };
        }

        // Abrir modal de película
        function openMovieModal(movie) {
            currentMovie = movie;
            addToContinueWatching(movie);
            
            document.getElementById('movie-modal-title').textContent = movie.title;
            document.getElementById('movie-modal-description').textContent = movie.description;
            
            const modalHeader = document.getElementById('movie-modal-header');
            if (movie.image && !movie.image.includes('svg')) {
                modalHeader.style.backgroundImage = `url(${movie.image})`;
            } else {
                modalHeader.style.background = '#333';
            }
            
            const mylistButton = document.getElementById('movie-mylist-button');
            if (myList.some(m => m.title === movie.title && m.type === 'movie')) {
                mylistButton.textContent = '✓ Mi lista';
                mylistButton.classList.add('play-button');
                mylistButton.classList.remove('info-button');
                mylistButton.onclick = function() {
                    removeFromMyList(movie);
                };
            } else {
                mylistButton.textContent = '+ Mi lista';
                mylistButton.classList.remove('play-button');
                mylistButton.classList.add('info-button');
                mylistButton.onclick = function() {
                    addToMyList(movie);
                };
            }
            
            document.getElementById('movie-modal').style.display = 'block';
            
            document.getElementById('movie-modal-play').onclick = function() {
                playMovie(movie);
            };
        }

        // Cerrar reproductor de video
        function closeVideoPlayer() {
            const videoPlayer = document.getElementById('video-player');
            const videoElement = document.getElementById('video-element');
            const videoIframe = document.getElementById('video-iframe');
            const videoControls = document.getElementById('video-controls');
            const iframeControls = document.getElementById('iframe-controls');
            const videoClose = document.getElementById('video-close');
            
            videoPlayer.style.display = 'none';
            
            if (isIframeMode) {
                videoIframe.src = '';
            } else {
                videoElement.pause();
                videoElement.src = '';
                
                playbackSpeed = 1;
                videoElement.playbackRate = 1;
                document.getElementById('speed-btn').textContent = '1x';
            }
            
            videoControls.style.display = 'block';
            iframeControls.style.display = 'flex';
            videoClose.style.display = 'flex';
            
            if (document.fullscreenElement) {
                document.exitFullscreen();
            }
        }

        // Función para mover el carrusel
        function moveCarousel(carouselId, direction) {
            const container = document.getElementById(carouselId);
            const scrollAmount = container.offsetWidth * 0.8 * direction;
            container.scrollBy({
                left: scrollAmount,
                behavior: 'smooth'
            });
        }
    </script>
</body>
</html>
