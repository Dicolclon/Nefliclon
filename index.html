<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NefliClon</title>
    <style>
        /* Estilos generales */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
        }
        
        body {
            background-color: #141414;
            color: #fff;
            line-height: 1.4;
        }
        
        a {
            text-decoration: none;
            color: inherit;
        }
        
        button {
            cursor: pointer;
            border: none;
        }
        
        /* Header y navegación */
        .header {
            position: fixed;
            top: 0;
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 50px;
            z-index: 1000;
            transition: background-color 0.3s;
        }
        
        .header.scrolled {
            background-color: #141414;
        }
        
        .logo {
            display: flex;
            align-items: center;
            font-size: 1.8rem;
            font-weight: bold;
        }
        
        .logo span {
            color: #E50914;
        }
        
        .nav-left {
            display: flex;
            align-items: center;
        }
        
        .nav-links {
            display: flex;
            list-style: none;
            margin-left: 30px;
        }
        
        .nav-links li {
            margin-left: 20px;
        }
        
        .nav-links a {
            font-size: 14px;
            transition: color 0.3s;
        }
        
        .nav-links a:hover {
            color: #b3b3b3;
        }
        
        .nav-right {
            display: flex;
            align-items: center;
        }
        
        .search-icon, .notifications, .profile {
            margin-left: 20px;
            cursor: pointer;
        }
        
        /* Banner principal */
        .banner {
            position: relative;
            height: 80vh;
            background: linear-gradient(to top, #141414, transparent 50%), 
                        linear-gradient(to right, #141414, transparent 30%),
                        url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="1200" height="675" viewBox="0 0 1200 675"><rect width="1200" height="675" fill="%23222"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" font-family="Arial" font-size="24" fill="%23fff">Imagen de película destacada</text></svg>');
            background-size: cover;
            background-position: center;
            display: flex;
            align-items: center;
            padding: 0 50px;
        }
        
        .banner-content {
            max-width: 40%;
            z-index: 2;
        }
        
        .banner-title {
            font-size: 3rem;
            font-weight: bold;
            margin-bottom: 20px;
        }
        
        .banner-buttons {
            display: flex;
            margin-top: 20px;
        }
        
        .banner-button {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 8px 24px;
            border-radius: 4px;
            font-weight: bold;
            margin-right: 10px;
            cursor: pointer;
            transition: opacity 0.3s;
        }
        
        .banner-button:hover {
            opacity: 0.8;
        }
        
        .play-button {
            background-color: #fff;
            color: #000;
        }
        
        .info-button {
            background-color: rgba(109, 109, 110, 0.7);
            color: #fff;
        }
        
        .banner-description {
            margin-top: 20px;
            font-size: 1.1rem;
            line-height: 1.5;
            color: #d2d2d2;
        }
        
        /* Secciones de contenido */
        .content-section {
            padding: 0 50px;
            margin-bottom: 40px;
        }
        
        .section-title {
            font-size: 1.4rem;
            margin-bottom: 15px;
            font-weight: bold;
        }
        
        /* Carrusel de películas */
        .carousel {
            position: relative;
            overflow: hidden;
        }
        
        .carousel-container {
            display: flex;
            gap: 5px;
            overflow-x: auto;
            scrollbar-width: none;
            -ms-overflow-style: none;
            scroll-behavior: smooth;
        }
        
        .carousel-container::-webkit-scrollbar {
            display: none;
        }
        
        .carousel-item {
            min-width: calc(20% - 4px);
            position: relative;
            border-radius: 4px;
            overflow: hidden;
            transition: transform 0.3s;
            cursor: pointer;
            flex-shrink: 0;
        }
        
        .carousel-item:hover {
            transform: scale(1.1);
            z-index: 10;
        }
        
        .carousel-item img {
            width: 100%;
            height: 450px; /* Altura fija */
            object-fit: cover; /* Para mantener la relación de aspecto */
            display: block;
        }
        
        .carousel-item.in-mylist::after {
            content: '✓';
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(0,0,0,0.7);
            color: #E50914;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            z-index: 2;
        }
        
        .progress-bar-wrapper {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background-color: rgba(255, 255, 255, 0.3);
        }
        
        .progress-bar-fill {
            height: 100%;
            background-color: #e50914;
            transition: width 0.3s ease;
        }
        
        .carousel-nav {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 50px;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 5;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .carousel:hover .carousel-nav {
            opacity: 1;
        }
        
        .carousel-nav.prev {
            left: 0;
        }
        
        .carousel-nav.next {
            right: 0;
        }
        
        /* Vista horizontal de series (solo en Mi Lista) */
        .horizontal-list {
            display: none;
            flex-direction: column;
            gap: 15px;
        }
        
        .horizontal-item {
            display: flex;
            background-color: #2f2f2f;
            border-radius: 8px;
            overflow: hidden;
            transition: transform 0.3s, background-color 0.3s;
            cursor: pointer;
        }
        
        .horizontal-item:hover {
            transform: translateY(-5px);
            background-color: #3a3a3a;
        }
        
        .horizontal-item-image {
            width: 150px;
            height: 200px;
            flex-shrink: 0;
            background-size: cover;
            background-position: center;
            position: relative;
        }
        
        .horizontal-item.in-mylist::after {
            content: '✓';
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.7);
            color: #E50914;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            z-index: 2;
        }
        
        .horizontal-item-content {
            padding: 20px;
            flex-grow: 1;
        }
        
        .horizontal-item-title {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .horizontal-item-info {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            color: #aaa;
            font-size: 0.9rem;
        }
        
        .horizontal-item-rating {
            color: #46d369;
            font-weight: bold;
        }
        
        .horizontal-item-description {
            margin-bottom: 15px;
            line-height: 1.5;
            color: #d2d2d2;
        }
        
        .horizontal-item-seasons {
            margin-bottom: 15px;
        }
        
        .horizontal-item-buttons {
            display: flex;
            gap: 10px;
        }
        
        .horizontal-item-button {
            padding: 8px 16px;
            border-radius: 4px;
            font-weight: bold;
            cursor: pointer;
            transition: opacity 0.3s;
        }
        
        .horizontal-item-button:hover {
            opacity: 0.8;
        }
        
        /* Botón de cambio de vista (solo en Mi Lista) */
        .view-toggle {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 15px;
        }
        
        .view-toggle-button {
            background-color: #333;
            color: #fff;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .view-toggle-button:hover {
            background-color: #444;
        }
        
        /* Modal de detalles de serie */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            overflow-y: auto;
        }
        
        .modal-content {
            background-color: #181818;
            margin: 50px auto;
            width: 90%;
            max-width: 1000px;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .modal-header {
            position: relative;
            height: 60vh;
            background-size: cover;
            background-position: center;
        }
        
        .modal-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            cursor: pointer;
        }
        
        .modal-body {
            padding: 30px;
        }
        
        .modal-title {
            font-size: 2.5rem;
            margin-bottom: 20px;
        }
        
        .modal-info {
            display: flex;
            margin-bottom: 20px;
        }
        
        .modal-rating {
            color: #46d369;
            font-weight: bold;
            margin-right: 15px;
        }
        
        .modal-year, .modal-seasons {
            margin-right: 15px;
        }
        
        .modal-description {
            margin-bottom: 30px;
            line-height: 1.6;
        }
        
        .seasons-container {
            margin-top: 30px;
        }
        
        .season-title {
            font-size: 1.5rem;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #333;
        }
        
        .episodes-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .episode-card {
            background-color: #2f2f2f;
            border-radius: 4px;
            overflow: hidden;
            transition: transform 0.3s;
            cursor: pointer;
        }
        
        .episode-card:hover {
            transform: scale(1.05);
        }
        
        .episode-image {
            width: 100%;
            height: 120px;
            background-color: #444;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #aaa;
        }
        
        .episode-info {
            padding: 10px;
        }
        
        .episode-number {
            font-size: 0.9rem;
            color: #aaa;
            margin-bottom: 5px;
        }
        
        .episode-name {
            font-size: 1rem;
            font-weight: bold;
        }
        
        /* Sección Mi Lista */
        #mylist-section {
            display: none;
            padding: 50px;
            margin-top: 100px;
        }
        
        #mylist-back {
            background: none;
            color: #fff;
            font-size: 1rem;
            margin-bottom: 20px;
            cursor: pointer;
            padding: 10px;
            border: 1px solid #333;
            border-radius: 4px;
            transition: background 0.3s;
        }
        
        #mylist-back:hover {
            background: #333;
        }
        
        /* Reproductor de video mejorado */
        .video-player {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #000;
            z-index: 3000;
        }
        
        .video-container {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            position: relative;
        }
        
        .video-player video, .video-player iframe {
            width: 100%;
            height: 100%;
            object-fit: contain;
            border: none;
        }
        
        .video-title {
            position: absolute;
            top: 20px;
            left: 20px;
            color: white;
            font-size: 1.2rem;
            background-color: rgba(0, 0, 0, 0.7);
            padding: 5px 10px;
            border-radius: 4px;
            transition: opacity 0.3s;
        }
        
        .video-title.hidden {
            opacity: 0;
        }
        
        .video-controls {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            padding: 20px;
            background: linear-gradient(to top, rgba(0,0,0,0.9), transparent);
            transition: opacity 0.3s;
        }
        
        .video-controls.hidden {
            opacity: 0;
        }
        
        .controls-top {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .video-controls-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .video-controls-right {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-left: auto;
        }
        
        .control-button {
            background: none;
            border: none;
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            transition: background-color 0.3s;
        }
        
        .control-button:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        .progress-container {
            width: 100%;
            height: 5px;
            background-color: rgba(255, 255, 255, 0.3);
            border-radius: 3px;
            cursor: pointer;
            position: relative;
        }
        
        .progress-fill {
            height: 100%;
            background-color: #e50914;
            border-radius: 3px;
            width: 0%;
            position: relative;
        }
        
        .progress-buffered {
            position: absolute;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
        }
        
        .time-display {
            color: white;
            font-size: 0.9rem;
            min-width: 100px;
        }
        
        .volume-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .volume-slider {
            width: 80px;
            height: 5px;
            background-color: rgba(255, 255, 255, 0.3);
            border-radius: 3px;
            cursor: pointer;
            position: relative;
        }
        
        .volume-fill {
            height: 100%;
            background-color: #fff;
            border-radius: 3px;
            width: 100%;
        }
        
        .video-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            cursor: pointer;
            z-index: 10;
        }
        
        /* Footer */
        .footer {
            padding: 50px;
            color: #808080;
        }
        
        .social-links {
            display: flex;
            margin-bottom: 20px;
        }
        
        .social-links a {
            margin-right: 15px;
            font-size: 1.5rem;
        }
        
        .footer-links {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .footer-links a {
            font-size: 13px;
        }
        
        .footer-links a:hover {
            text-decoration: underline;
        }
        
        .service-code {
            border: 1px solid #808080;
            padding: 6px;
            background: transparent;
            color: #808080;
            margin-bottom: 20px;
            font-size: 13px;
        }
        
        .copyright {
            font-size: 11px;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .header {
                padding: 20px;
            }
            
            .nav-links {
                display: none;
            }
            
            .banner {
                height: 60vh;
                padding: 0 20px;
            }
            
            .banner-content {
                max-width: 100%;
            }
            
            .banner-title {
                font-size: 2rem;
            }
            
            .content-section {
                padding: 0 20px;
                margin-bottom: 20px;
            }
            
            .carousel-item {
                min-width: calc(33.33% - 4px);
            }
            
            .carousel-item img {
                height: 300px; /* Altura reducida en móviles */
            }
            
            .horizontal-item {
                flex-direction: column;
            }
            
            .horizontal-item-image {
                width: 100%;
                height: 200px;
            }
            
            .episodes-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            }
            
            .footer-links {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .volume-slider {
                width: 60px;
            }
        }
    </style>
</head>
<body>
    <!-- Input oculto para selección de archivos M3U y JSON -->
    <input type="file" id="m3u-files" multiple accept=".m3u,.m3u8,.json" style="display: none;">

    <!-- Header -->
    <header class="header">
        <div class="nav-left">
            <a href="#" class="logo">
                <span>NefliClon</span>
            </a>
            <ul class="nav-links">
                <li><a href="#" onclick="selectM3UFiles()">Subir M3U</a></li>
                <li><a href="#" onclick="showHome()">Inicio</a></li>
                <li><a href="#" onclick="showSeries()">Series</a></li>
                <li><a href="#" onclick="showMovies()">Películas</a></li>
                <li><a href="#" onclick="showHome()">Novedades populares</a></li>
                <li><a href="#" onclick="showMyList()">Mi lista</a></li>
            </ul>
        </div>
        <div class="nav-right">
            <div class="search-icon">🔍</div>
            <div class="notifications">🔔</div>
            <div class="profile">👤</div>
        </div>
    </header>

    <!-- Banner principal -->
    <section class="banner" id="banner-section">
        <div class="banner-content">
            <h1 class="banner-title" id="banner-title">Bienvenido a NefliClon</h1>
            <p class="banner-description" id="banner-description">Carga tus archivos M3U o JSON para comenzar a ver tu contenido favorito.</p>
            <div class="banner-buttons">
                <button class="banner-button play-button" id="banner-play">▶ Reproducir</button>
                <button class="banner-button info-button" id="banner-info">ⓘ Más información</button>
            </div>
        </div>
    </section>

    <!-- Sección de Series -->
    <section class="content-section" id="series-section">
        <h2 class="section-title">Tus series</h2>
        
        <!-- Vista carrusel (cuadrícula) -->
        <div class="carousel" id="series-carousel-container">
            <div class="carousel-container" id="series-carousel">
                <!-- Las series cargadas desde M3U aparecerán aquí en formato cuadrícula -->
            </div>
            <div class="carousel-nav prev" onclick="moveCarousel('series-carousel', -1)">‹</div>
            <div class="carousel-nav next" onclick="moveCarousel('series-carousel', 1)">›</div>
        </div>
    </section>

    <!-- Sección de Películas -->
    <section class="content-section" id="movies-section">
        <h2 class="section-title">Tus películas</h2>
        
        <!-- Vista carrusel (cuadrícula) -->
        <div class="carousel" id="movies-carousel-container">
            <div class="carousel-container" id="movies-carousel">
                <!-- Las películas cargadas desde JSON aparecerán aquí en formato cuadrícula -->
            </div>
            <div class="carousel-nav prev" onclick="moveCarousel('movies-carousel', -1)">‹</div>
            <div class="carousel-nav next" onclick="moveCarousel('movies-carousel', 1)">›</div>
        </div>
    </section>

    <section class="content-section" id="continue-section">
        <h2 class="section-title">Continuar viendo</h2>
        <div class="carousel">
            <div class="carousel-container" id="continue-carousel">
                <!-- Elementos del carrusel generados con JS -->
            </div>
            <div class="carousel-nav prev" onclick="moveCarousel('continue-carousel', -1)">‹</div>
            <div class="carousel-nav next" onclick="moveCarousel('continue-carousel', 1)">›</div>
        </div>
    </section>

    <!-- Sección Mi Lista -->
    <section id="mylist-section">
        <button id="mylist-back" onclick="showHome()">← Volver al inicio</button>
        <div class="view-toggle">
            <button class="view-toggle-button" id="view-toggle">Cambiar a vista cuadrícula</button>
        </div>
        <h2 class="section-title">Mi lista</h2>
        
        <!-- Vista horizontal (por defecto en Mi Lista) -->
        <div class="horizontal-list" id="mylist-horizontal">
            <!-- Las series en Mi Lista aparecerán aquí en formato horizontal -->
        </div>
        
        <!-- Vista carrusel (cuadrícula) -->
        <div class="carousel" id="mylist-carousel-container">
            <div class="carousel-container" id="mylist-carousel">
                <!-- Las series en Mi Lista aparecerán aquí en formato cuadrícula -->
            </div>
            <div class="carousel-nav prev" onclick="moveCarousel('mylist-carousel', -1)">‹</div>
            <div class="carousel-nav next" onclick="moveCarousel('mylist-carousel', 1)">›</div>
        </div>
    </section>

    <!-- Modal de detalles de serie -->
    <div class="modal" id="series-modal">
        <div class="modal-content">
            <div class="modal-header" id="modal-header">
                <div class="modal-close" id="modal-close">×</div>
            </div>
            <div class="modal-body">
                <h2 class="modal-title" id="modal-title">Título de la serie</h2>
                <div class="modal-info">
                    <span class="modal-rating" id="modal-rating">96% de coincidencia</span>
                    <span class="modal-year" id="modal-year">2024</span>
                    <span class="modal-seasons" id="modal-seasons">2 Temporadas</span>
                </div>
                <p class="modal-description" id="modal-description">Descripción de la serie.</p>
                <div class="banner-buttons">
                    <button class="banner-button play-button" id="modal-play">▶ Reproducir</button>
                    <button class="banner-button info-button" id="mylist-button">+ Mi lista</button>
                </div>
                
                <div class="seasons-container" id="seasons-container">
                    <!-- Las temporadas y episodios se cargarán aquí -->
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de detalles de película -->
    <div class="modal" id="movie-modal">
        <div class="modal-content">
            <div class="modal-header" id="movie-modal-header">
                <div class="modal-close" id="movie-modal-close">×</div>
            </div>
            <div class="modal-body">
                <h2 class="modal-title" id="movie-modal-title">Título de la película</h2>
                <div class="modal-info">
                    <span class="modal-rating" id="movie-modal-rating">96% de coincidencia</span>
                    <span class="modal-year" id="movie-modal-year">2024</span>
                </div>
                <p class="modal-description" id="movie-modal-description">Descripción de la película.</p>
                <div class="banner-buttons">
                    <button class="banner-button play-button" id="movie-modal-play">▶ Reproducir</button>
                    <button class="banner-button info-button" id="movie-mylist-button">+ Mi lista</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Reproductor de video mejorado -->
    <div class="video-player" id="video-player">
        <div class="video-container">
            <div class="video-title" id="video-title">Título del episodio</div>
            <video id="video-element"></video>
            <iframe id="video-iframe" style="display:none; width:100%; height:100%; border:none;"></iframe>
            <div class="video-controls" id="video-controls">
                <div class="progress-container" id="progress-container">
                    <div class="progress-buffered" id="progress-buffered"></div>
                    <div class="progress-fill" id="progress-fill"></div>
                </div>
                <div class="controls-top">
                    <div class="video-controls-left">
                        <button class="control-button" id="play-pause-btn"⏸️</button>
                        <button class="control-button" id="backward-btn">⏪</button>
                        <button class="control-button" id="forward-btn">⏩</button>
                        <div class="volume-container">
                            <button class="control-button" id="volume-btn">🔊</button>
                            <div class="volume-slider" id="volume-slider">
                                <div class="volume-fill" id="volume-fill"></div>
                            </div>
                        </div>
                        <div class="time-display">
                            <span id="current-time">0:00</span> / <span id="duration">0:00</span>
                        </div>
                    </div>
                    <div class="video-controls-right">
                        <button class="control-button" id="speed-btn">1x</button>
                        <button class="control-button" id="fullscreen-btn">⛶</button>
                    </div>
                </div>
            </div>
            <div class="video-close" id="video-close">×</div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="social-links">
            <a href="#">📘</a>
            <a href="#">🐦</a>
            <a href="#">📷</a>
        </div>
        <div class="footer-links">
            <a href="#">Audio y subtítulos</a>
            <a href="#">Zona de prensa</a>
            <a href="#">Privacidad</a>
            <a href="#">Contáctanos</a>
            <a href="#">Descripción de audio</a>
            <a href="#">Relaciones con inversionistas</a>
            <a href="#">Avisos legales</a>
            <a href="#">Centro de ayuda</a>
            <a href="#">Empleo</a>
            <a href="#">Preferencias de cookies</a>
            <a href="#">Tarjetas de regalo</a>
            <a href="#">Términos de uso</a>
            <a href="#">Información corporativa</a>
        </div>
        <button class="service-code">Código de servicio</button>
        <div class="copyright">© 1997-2025 NefliClon, Inc.</div>
    </footer>

    <script>
        // Variables globales
        let seriesData = [];
        let moviesData = [];
        let myList = [];
        let currentSeries = null;
        let currentMovie = null;
        let currentBannerSeries = null;
        let currentVideo = null;
        let continueWatching = []; // Lista simplificada para continuar viendo
        let playbackSpeed = 1;
        let currentView = 'horizontal'; // Vista por defecto en Mi Lista
        let isIframeMode = false; // Para controlar si estamos usando iframe o video

        // Función para guardar datos en localStorage
        function saveData() {
            localStorage.setItem('nefliclon_series', JSON.stringify(seriesData));
            localStorage.setItem('nefliclon_movies', JSON.stringify(moviesData));
            localStorage.setItem('nefliclon_mylist', JSON.stringify(myList));
            localStorage.setItem('nefliclon_continue', JSON.stringify(continueWatching));
        }

        // Inicializar la aplicación
        document.addEventListener('DOMContentLoaded', function() {
            // Cargar desde localStorage
            const savedSeries = localStorage.getItem('nefliclon_series');
            if (savedSeries) {
                seriesData = JSON.parse(savedSeries);
                updateSeriesCarousel();
                updateMyListViews();
                updateBanner();
            }
            
            const savedMovies = localStorage.getItem('nefliclon_movies');
            if (savedMovies) {
                moviesData = JSON.parse(savedMovies);
                updateMoviesCarousel();
            }
            
            const savedMyList = localStorage.getItem('nefliclon_mylist');
            if (savedMyList) {
                myList = JSON.parse(savedMyList);
            }
            
            const savedContinue = localStorage.getItem('nefliclon_continue');
            if (savedContinue) {
                continueWatching = JSON.parse(savedContinue);
                updateContinueCarousel();
            }
            
            setupEventListeners();
            setupVideoControls();
            updateContinueCarousel();
            
            // Establecer vista por defecto en Mi Lista
            setMyListView(currentView);
            
            // Efecto de scroll en el header
            window.addEventListener('scroll', function() {
                const header = document.querySelector('.header');
                if (window.scrollY > 100) {
                    header.classList.add('scrolled');
                } else {
                    header.classList.remove('scrolled');
                }
            });
        });

        // Configurar event listeners
        function setupEventListeners() {
            const fileInput = document.getElementById('m3u-files');
            
            fileInput.addEventListener('change', function() {
                for (let f of Array.from(this.files)) {
                    if (f.name.endsWith('.m3u') || f.name.endsWith('.m3u8')) {
                        processM3UFile(f);
                    } else if (f.name.endsWith('.json')) {
                        processJSONFile(f);
                    }
                }
            });
            
            // Cerrar modales
            document.getElementById('modal-close').addEventListener('click', function() {
                document.getElementById('series-modal').style.display = 'none';
            });
            
            document.getElementById('movie-modal-close').addEventListener('click', function() {
                document.getElementById('movie-modal').style.display = 'none';
            });
            
            // Cerrar reproductor de video
            document.getElementById('video-close').addEventListener('click', function() {
                closeVideoPlayer();
            });
            
            // Botón de cambio de vista (solo en Mi Lista)
            document.getElementById('view-toggle').addEventListener('click', function() {
                toggleMyListView();
            });
        }

        // Cambiar entre vistas en Mi Lista
        function toggleMyListView() {
            if (currentView === 'horizontal') {
                setMyListView('grid');
            } else {
                setMyListView('horizontal');
            }
        }

        // Establecer vista específica en Mi Lista
        function setMyListView(view) {
            currentView = view;
            const horizontalList = document.getElementById('mylist-horizontal');
            const carouselContainer = document.getElementById('mylist-carousel-container');
            const toggleButton = document.getElementById('view-toggle');
            
            if (view === 'horizontal') {
                horizontalList.style.display = 'flex';
                carouselContainer.style.display = 'none';
                toggleButton.textContent = 'Cambiar a vista cuadrícula';
            } else {
                horizontalList.style.display = 'none';
                carouselContainer.style.display = 'block';
                toggleButton.textContent = 'Cambiar a vista horizontal';
            }
        }

        // Configurar controles del reproductor de video
        function setupVideoControls() {
            const video = document.getElementById('video-element');
            const playPauseBtn = document.getElementById('play-pause-btn');
            const backwardBtn = document.getElementById('backward-btn');
            const forwardBtn = document.getElementById('forward-btn');
            const progressContainer = document.getElementById('progress-container');
            const progressFill = document.getElementById('progress-fill');
            const progressBuffered = document.getElementById('progress-buffered');
            const currentTimeElement = document.getElementById('current-time');
            const durationElement = document.getElementById('duration');
            const volumeBtn = document.getElementById('volume-btn');
            const volumeSlider = document.getElementById('volume-slider');
            const volumeFill = document.getElementById('volume-fill');
            const speedBtn = document.getElementById('speed-btn');
            const fullscreenBtn = document.getElementById('fullscreen-btn');
            const videoControls = document.getElementById('video-controls');
            const videoTitle = document.getElementById('video-title');
            
            let controlsTimeout;
            
            // Mostrar/ocultar controles al mover el mouse
            document.getElementById('video-player').addEventListener('mousemove', function() {
                if (!isIframeMode) {
                    videoControls.classList.remove('hidden');
                    videoTitle.classList.remove('hidden');
                    clearTimeout(controlsTimeout);
                    controlsTimeout = setTimeout(() => {
                        if (!video.paused) {
                            videoControls.classList.add('hidden');
                            videoTitle.classList.add('hidden');
                        }
                    }, 3000);
                }
            });
            
            // Botón play/pause (solo para video, no para iframe)
            playPauseBtn.addEventListener('click', function() {
                if (!isIframeMode && !video.paused) {
                    video.pause();
                    playPauseBtn.innerHTML = '▶️';
                } else if (!isIframeMode) {
                    video.play();
                    playPauseBtn.innerHTML = '⏸️';
                }
            });
            
            // Retroceder 10 segundos (solo para video)
            backwardBtn.addEventListener('click', function() {
                if (!isIframeMode) {
                    video.currentTime -= 10;
                }
            });
            
            // Adelantar 10 segundos (solo para video)
            forwardBtn.addEventListener('click', function() {
                if (!isIframeMode) {
                    video.currentTime += 10;
                }
            });
            
            // Control de volumen (solo para video)
            volumeBtn.addEventListener('click', function() {
                if (!isIframeMode) {
                    if (video.muted || video.volume === 0) {
                        video.muted = false;
                        video.volume = 1;
                        volumeFill.style.width = '100%';
                        volumeBtn.innerHTML = '🔊';
                    } else {
                        video.muted = true;
                        volumeFill.style.width = '0%';
                        volumeBtn.innerHTML = '🔇';
                    }
                }
            });
            
            // Slider de volumen (solo para video)
            volumeSlider.addEventListener('click', function(e) {
                if (!isIframeMode) {
                    const rect = volumeSlider.getBoundingClientRect();
                    const percent = (e.clientX - rect.left) / rect.width;
                    video.volume = Math.max(0, Math.min(1, percent));
                    volumeFill.style.width = `${percent * 100}%`;
                    video.muted = false;
                    volumeBtn.innerHTML = video.volume === 0 ? '🔇' : '🔊';
                }
            });
            
            // Control de velocidad (solo para video)
            speedBtn.addEventListener('click', function() {
                if (!isIframeMode) {
                    const speeds = [0.5, 0.75, 1, 1.25, 1.5, 2];
                    const currentIndex = speeds.indexOf(playbackSpeed);
                    const nextIndex = (currentIndex + 1) % speeds.length;
                    playbackSpeed = speeds[nextIndex];
                    video.playbackRate = playbackSpeed;
                    speedBtn.textContent = playbackSpeed + 'x';
                }
            });
            
            // Actualizar progreso (solo para video)
            video.addEventListener('timeupdate', function() {
                if (!isIframeMode) {
                    const percent = (video.currentTime / video.duration) * 100;
                    progressFill.style.width = `${percent}%`;
                    
                    currentTimeElement.textContent = formatTime(video.currentTime);
                    durationElement.textContent = formatTime(video.duration);
                }
            });
            
            // Actualizar buffer (solo para video)
            video.addEventListener('progress', function() {
                if (!isIframeMode && video.buffered.length > 0) {
                    const bufferedEnd = video.buffered.end(video.buffered.length - 1);
                    const duration = video.duration;
                    if (duration > 0) {
                        progressBuffered.style.width = `${(bufferedEnd / duration) * 100}%`;
                    }
                }
            });
            
            // Click en la barra de progreso (solo para video)
            progressContainer.addEventListener('click', function(e) {
                if (!isIframeMode) {
                    const rect = progressContainer.getBoundingClientRect();
                    const percent = (e.clientX - rect.left) / rect.width;
                    video.currentTime = percent * video.duration;
                }
            });
            
            // Botón de pantalla completa
            fullscreenBtn.addEventListener('click', function() {
                if (!document.fullscreenElement) {
                    document.getElementById('video-player').requestFullscreen().catch(err => {
                        console.log(`Error attempting to enable full-screen mode: ${err.message}`);
                    });
                } else {
                    document.exitFullscreen();
                }
            });
            
            // Eventos de video (solo para video)
            video.addEventListener('play', function() {
                if (!isIframeMode) {
                    playPauseBtn.innerHTML = '⏸️';
                }
            });
            
            video.addEventListener('pause', function() {
                if (!isIframeMode) {
                    playPauseBtn.innerHTML = '▶️';
                }
            });
            
            // Eventos de teclado
            document.addEventListener('keydown', function(e) {
                if (document.getElementById('video-player').style.display === 'block' && !isIframeMode) {
                    switch(e.key) {
                        case ' ':
                        case 'k':
                            e.preventDefault();
                            playPauseBtn.click();
                            break;
                        case 'f':
                            e.preventDefault();
                            fullscreenBtn.click();
                            break;
                        case 'm':
                            e.preventDefault();
                            volumeBtn.click();
                            break;
                        case 'ArrowLeft':
                            e.preventDefault();
                            backwardBtn.click();
                            break;
                        case 'ArrowRight':
                            e.preventDefault();
                            forwardBtn.click();
                            break;
                        case 'ArrowUp':
                            e.preventDefault();
                            video.volume = Math.min(1, video.volume + 0.1);
                            volumeFill.style.width = `${video.volume * 100}%`;
                            break;
                        case 'ArrowDown':
                            e.preventDefault();
                            video.volume = Math.max(0, video.volume - 0.1);
                            volumeFill.style.width = `${video.volume * 100}%`;
                            break;
                    }
                }
            });
        }

        // Formatear tiempo en MM:SS o HH:MM:SS
        function formatTime(seconds) {
            if (isNaN(seconds)) return '0:00';
            
            const hours = Math.floor(seconds / 3600);
            const mins = Math.floor((seconds % 3600) / 60);
            const secs = Math.floor(seconds % 60);
            
            if (hours > 0) {
                return `${hours}:${mins < 10 ? '0' : ''}${mins}:${secs < 10 ? '0' : ''}${secs}`;
            } else {
                return `${mins}:${secs < 10 ? '0' : ''}${secs}`;
            }
        }

        // Función para seleccionar archivos M3U
        function selectM3UFiles() {
            document.getElementById('m3u-files').click();
        }

        // Procesar archivo M3U
        function processM3UFile(file) {
            const reader = new FileReader();
            
            reader.onload = function(e) {
                const content = e.target.result;
                const series = parseM3UContent(content, file.name);
                if (series && series.seasons) {
                    // Verificar si ya existe para evitar duplicados
                    const existingIndex = seriesData.findIndex(s => s.title === series.title);
                    if (existingIndex > -1) {
                        // Actualizar en lugar de agregar
                        seriesData[existingIndex] = series;
                    } else {
                        seriesData.push(series);
                    }
                    updateSeriesCarousel();
                    updateMyListViews();
                    updateBanner();
                    updateContinueCarousel();
                    saveData();
                }
            };
            
            reader.readAsText(file);
        }

        // Procesar archivo JSON
        function processJSONFile(file) {
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const content = JSON.parse(e.target.result);
                    const movies = parseJSONContent(content, file.name);
                    if (movies && movies.length > 0) {
                        // Verificar y actualizar películas existentes
                        movies.forEach(movie => {
                            const existingIndex = moviesData.findIndex(m => m.title === movie.title);
                            if (existingIndex > -1) {
                                // Actualizar en lugar de agregar
                                moviesData[existingIndex] = movie;
                            } else {
                                moviesData.push(movie);
                            }
                        });
                        updateMoviesCarousel();
                        saveData();
                    }
                } catch (error) {
                    console.error('Error al procesar JSON:', error);
                }
            };
            
            reader.readAsText(file);
        }

        // Parsear contenido JSON
        function parseJSONContent(content, fileName) {
            if (!Array.isArray(content)) {
                console.error('El contenido JSON debe ser un array');
                return [];
            }
            
            return content.map(item => {
                return {
                    title: item.title || 'Película sin título',
                    image: item.image || createPlaceholderImage(item.title || 'Película'),
                    video: item.video,
                    description: `Película: ${item.title || 'Sin título'}`,
                    type: 'movie'
                };
            });
        }

        // Parsear contenido M3U
        function parseM3UContent(content, fileName) {
            const lines = content.split('\n');
            let episodes = [];
            let firstLogo = '';
            
            // Primero, recolectar todos los episodios
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                
                if (line.startsWith('#EXTINF:')) {
                    const urlLine = lines[i + 1] ? lines[i + 1].trim() : '';
                    
                    if (urlLine && !urlLine.startsWith('#')) {
                        // Extraer información del EXTINF
                        let title = '';
                        let logo = '';
                        
                        // Intentar múltiples formatos de parsing
                        // Formato 1: #EXTINF:-1 tvg-logo="..." group-title="...",Título
                        const format1Match = line.match(/#EXTINF:[^,]*,(.+)$/);
                        if (format1Match) {
                            title = format1Match[1].trim();
                        }
                        
                        // Extraer logo
                        const logoMatch = line.match(/tvg-logo="([^"]+)"/);
                        if (logoMatch) {
                            logo = logoMatch[1];
                            if (!firstLogo) firstLogo = logo;
                        }
                        
                        // Limpiar el título de caracteres especiales innecesarios
                        title = title.replace(/[\[\]]/g, '').trim();
                        
                        if (title) {
                            episodes.push({
                                title: title,
                                logo: logo,
                                url: urlLine,
                                originalLine: line
                            });
                        }
                    }
                }
            }
            
            // Organizar episodios en temporadas
            const seasons = organizeSeasonsFromEpisodes(episodes);
            
            // Determinar el título de la serie
            const seriesTitle = extractSeriesTitle(fileName, episodes);
            
            return {
                title: seriesTitle,
                description: `Serie con ${episodes.length} episodios`,
                image: firstLogo || createPlaceholderImage(seriesTitle),
                seasons: seasons,
                totalEpisodes: episodes.length,
                type: 'series'
            };
        }

        // Organizar episodios en temporadas de manera inteligente
        function organizeSeasonsFromEpisodes(episodes) {
            const seasons = {};
            let currentSeason = 1;
            let episodeInSeason = 0;
            
            episodes.forEach((episode, index) => {
                const title = episode.title.toUpperCase();
                
                // Detectar marcadores de temporada
                const seasonMarkers = [
                    /TEMPORADA\s*(\d+)/i,
                    /TEMP\s*(\d+)/i,
                    /T(\d+)/,
                    /S(\d+)/,
                    /SEASON\s*(\d+)/i,
                    /\s+(\d+)x\d+/  // Formato 1x01, 2x01, etc.
                ];
                
                let detectedSeason = null;
                for (const marker of seasonMarkers) {
                    const match = title.match(marker);
                    if (match) {
                        detectedSeason = parseInt(match[1]);
                        break;
                    }
                }
                
                // Si se detecta una nueva temporada
                if (detectedSeason && detectedSeason !== currentSeason) {
                    currentSeason = detectedSeason;
                    episodeInSeason = 0;
                }
                
                // Detectar número de episodio
                const episodeMarkers = [
                    /CAP[ÍI]?TULO?\s*(\d+)/i,
                    /CAP\s*(\d+)/i,
                    /EP[ISODIO]*\s*(\d+)/i,
                    /E(\d+)/,
                    /\d+x(\d+)/,  // Formato 1x01
                    /\s+(\d+)\s*$/  // Número al final
                ];
                
                let detectedEpisode = null;
                for (const marker of episodeMarkers) {
                    const match = title.match(marker);
                    if (match) {
                        detectedEpisode = parseInt(match[1]);
                        break;
                    }
                }
                
                // Si no se detecta número, usar contador
                episodeInSeason++;
                const episodeNumber = detectedEpisode || episodeInSeason;
                
                // Inicializar temporada si no existe
                if (!seasons[currentSeason]) {
                    seasons[currentSeason] = [];
                }
                
                // Agregar episodio a la temporada
                seasons[currentSeason].push({
                    ...episode,
                    season: currentSeason,
                    episode: episodeNumber,
                    cleanTitle: cleanEpisodeTitle(episode.title)
                });
            });
            
            // Si no se detectaron temporadas, poner todo en temporada 1
            if (Object.keys(seasons).length === 0 && episodes.length > 0) {
                seasons[1] = episodes.map((ep, idx) => ({
                    ...ep,
                    season: 1,
                    episode: idx + 1,
                    cleanTitle: cleanEpisodeTitle(ep.title)
                }));
            }
            
            return seasons;
        }

        // Limpiar título de episodio
        function cleanEpisodeTitle(title) {
            // Remover información de temporada/episodio del título
            let clean = title;
            
            // Remover patrones comunes
            clean = clean.replace(/^(TEMPORADA|TEMP|T|S)\s*\d+\s*/i, '');
            clean = clean.replace(/^(CAP[ÍI]?TULO?|CAP|EP[ISODIO]*|E)\s*\d+\s*/i, '');
            clean = clean.replace(/^\d+x\d+\s*[-:]?\s*/i, '');
            clean = clean.replace(/^\d+\s*[-:]?\s*/i, '');
            
            return clean.trim() || title;
        }

        // Extraer título de la serie
        function extractSeriesTitle(fileName, episodes) {
            // Intentar extraer del nombre del archivo
            let seriesTitle = fileName.replace(/\.m3u8?$/i, '').replace(/[_-]/g, ' ').trim();
            
            // Si el nombre del archivo es genérico, intentar extraer de los episodios
            if (seriesTitle.toLowerCase() === 'playlist' || seriesTitle.toLowerCase() === 'lista' || !seriesTitle) {
                // Buscar patrones comunes en los títulos de episodios
                if (episodes.length > 0) {
                    const firstTitle = episodes[0].title;
                    // Intentar extraer el nombre de la serie del primer episodio
                    const seriesMatch = firstTitle.match(/^([^-–]+?)(?:\s*[-–]|\s+(?:TEMPORADA|TEMP|T|S)\s*\d+)/i);
                    if (seriesMatch) {
                        seriesTitle = seriesMatch[1].trim();
                    }
                }
            }
            
            return seriesTitle || 'Serie sin título';
        }

        // Crear imagen placeholder
        function createPlaceholderImage(title) {
            const colors = ['#e50914', '#333', '#444', '#555', '#666'];
            const color = colors[Math.floor(Math.random() * colors.length)];
            return `data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='300' height='450' viewBox='0 0 300 450'><rect width='300' height='450' fill='${color}'/><text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' font-family='Arial' font-size='18' fill='%23fff'>${encodeURIComponent(title)}</text></svg>`;
        }

        // Actualizar banner con serie random
        function updateBanner() {
            if (seriesData.length === 0 && moviesData.length === 0) return;
            
            // Combinar series y películas para el banner
            const allContent = [...seriesData, ...moviesData];
            const randomIndex = Math.floor(Math.random() * allContent.length);
            currentBannerSeries = allContent[randomIndex];
            
            const banner = document.querySelector('.banner');
            const bannerTitle = document.getElementById('banner-title');
            const bannerDesc = document.getElementById('banner-description');
            
            bannerTitle.textContent = currentBannerSeries.title;
            bannerDesc.textContent = currentBannerSeries.description;
            
            if (currentBannerSeries.image && !currentBannerSeries.image.includes('svg')) {
                banner.style.background = `linear-gradient(to top, #141414, transparent 50%), linear-gradient(to right, #141414, transparent 30%), url('${currentBannerSeries.image}')`;
            }
            
            banner.style.backgroundSize = 'cover';
            banner.style.backgroundPosition = 'center';
            
            // Configurar botones del banner
            document.getElementById('banner-play').onclick = function() {
                if (currentBannerSeries.type === 'series') {
                    playFirstEpisode(currentBannerSeries);
                } else {
                    playMovie(currentBannerSeries);
                }
            };
            
            document.getElementById('banner-info').onclick = function() {
                if (currentBannerSeries.type === 'series') {
                    openSeriesModal(currentBannerSeries);
                } else {
                    openMovieModal(currentBannerSeries);
                }
            };
        }

        // Reproducir primer episodio de una serie
        function playFirstEpisode(series) {
            const firstSeason = Object.keys(series.seasons).find(s => series.seasons[s] && series.seasons[s].length > 0);
            if (firstSeason && series.seasons[firstSeason].length > 0) {
                playEpisode(series.seasons[firstSeason][0], series.title);
            }
        }

        // Reproducir película
        function playMovie(movie) {
            const videoPlayer = document.getElementById('video-player');
            const videoElement = document.getElementById('video-element');
            const videoIframe = document.getElementById('video-iframe');
            const videoTitle = document.getElementById('video-title');
            const videoControls = document.getElementById('video-controls');
            
            currentVideo = {
                movie: movie
            };
            
            // Usar iframe para películas JSON
            isIframeMode = true;
            videoElement.style.display = 'none';
            videoIframe.style.display = 'block';
            videoIframe.src = movie.video;
            videoTitle.textContent = movie.title;
            videoPlayer.style.display = 'block';
            
            // Ocultar controles para iframe
            videoControls.style.display = 'none';
            
            // Cerrar modal si está abierto
            document.getElementById('movie-modal').style.display = 'none';
        }

        // Actualizar carrusel de series
        function updateSeriesCarousel() {
            const carousel = document.getElementById('series-carousel');
            carousel.innerHTML = '';
            
            seriesData.forEach(series => {
                const item = document.createElement('div');
                item.className = `carousel-item ${myList.some(m => m.title === series.title && m.type === 'series') ? 'in-mylist' : ''}`;
                item.addEventListener('click', function() {
                    openSeriesModal(series);
                });
                
                const img = document.createElement('img');
                img.src = series.image;
                img.alt = series.title;
                img.onerror = function() {
                    this.src = createPlaceholderImage(series.title);
                };
                
                item.appendChild(img);
                carousel.appendChild(item);
            });
        }

        // Actualizar carrusel de películas
        function updateMoviesCarousel() {
            const carousel = document.getElementById('movies-carousel');
            carousel.innerHTML = '';
            
            moviesData.forEach(movie => {
                const item = document.createElement('div');
                item.className = `carousel-item ${myList.some(m => m.title === movie.title && m.type === 'movie') ? 'in-mylist' : ''}`;
                item.addEventListener('click', function() {
                    openMovieModal(movie);
                });
                
                const img = document.createElement('img');
                img.src = movie.image;
                img.alt = movie.title;
                img.onerror = function() {
                    this.src = createPlaceholderImage(movie.title);
                };
                
                item.appendChild(img);
                carousel.appendChild(item);
            });
        }

        // Actualizar vistas de Mi Lista
        function updateMyListViews() {
            updateMyListCarousel();
            updateMyListHorizontal();
        }

        // Actualizar carrusel de Mi Lista
        function updateMyListCarousel() {
            const carousel = document.getElementById('mylist-carousel');
            carousel.innerHTML = '';
            
            myList.forEach(item => {
                const itemEl = document.createElement('div');
                itemEl.className = 'carousel-item in-mylist';
                itemEl.addEventListener('click', function() {
                    if (item.type === 'series') {
                        openSeriesModal(item);
                    } else {
                        openMovieModal(item);
                    }
                });
                
                const img = document.createElement('img');
                img.src = item.image;
                img.alt = item.title;
                img.onerror = function() {
                    this.src = createPlaceholderImage(item.title);
                };
                
                itemEl.appendChild(img);
                carousel.appendChild(itemEl);
            });
        }

        // Actualizar lista horizontal de Mi Lista
        function updateMyListHorizontal() {
            const horizontalList = document.getElementById('mylist-horizontal');
            horizontalList.innerHTML = '';
            
            myList.forEach(item => {
                const itemEl = document.createElement('div');
                itemEl.className = 'horizontal-item in-mylist';
                itemEl.addEventListener('click', function() {
                    if (item.type === 'series') {
                        openSeriesModal(item);
                    } else {
                        openMovieModal(item);
                    }
                });
                
                const imageDiv = document.createElement('div');
                imageDiv.className = 'horizontal-item-image';
                imageDiv.style.backgroundImage = `url(${item.image})`;
                
                const contentDiv = document.createElement('div');
                contentDiv.className = 'horizontal-item-content';
                
                const title = document.createElement('h3');
                title.className = 'horizontal-item-title';
                title.textContent = item.title;
                
                const info = document.createElement('div');
                info.className = 'horizontal-item-info';
                
                const rating = document.createElement('span');
                rating.className = 'horizontal-item-rating';
                rating.textContent = '95% de coincidencia';
                
                const year = document.createElement('span');
                year.textContent = '2024';
                
                const typeInfo = document.createElement('span');
                typeInfo.textContent = item.type === 'series' ? `${Object.keys(item.seasons).length} Temporadas` : 'Película';
                
                info.appendChild(rating);
                info.appendChild(year);
                info.appendChild(typeInfo);
                
                const description = document.createElement('p');
                description.className = 'horizontal-item-description';
                description.textContent = item.description;
                
                const buttons = document.createElement('div');
                buttons.className = 'horizontal-item-buttons';
                
                const playButton = document.createElement('button');
                playButton.className = 'horizontal-item-button play-button';
                playButton.textContent = '▶ Reproducir';
                playButton.addEventListener('click', function(e) {
                    e.stopPropagation();
                    if (item.type === 'series') {
                        playFirstEpisode(item);
                    } else {
                        playMovie(item);
                    }
                });
                
                const removeButton = document.createElement('button');
                removeButton.className = 'horizontal-item-button info-button';
                removeButton.textContent = '✕ Quitar de Mi Lista';
                removeButton.addEventListener('click', function(e) {
                    e.stopPropagation();
                    removeFromMyList(item);
                });
                
                buttons.appendChild(playButton);
                buttons.appendChild(removeButton);
                
                contentDiv.appendChild(title);
                contentDiv.appendChild(info);
                contentDiv.appendChild(description);
                contentDiv.appendChild(buttons);
                
                itemEl.appendChild(imageDiv);
                itemEl.appendChild(contentDiv);
                
                horizontalList.appendChild(itemEl);
            });
        }

        // Agregar o actualizar item en continuar viendo (simplificado)
        function addToContinueWatching(item) {
            // Buscar si ya existe
            const existingIndex = continueWatching.findIndex(i => i.title === item.title);
            if (existingIndex > -1) {
                // Actualizar timestamp para mantenerlo arriba
                continueWatching[existingIndex].timestamp = Date.now();
            } else {
                // Agregar nuevo con progreso simulado
                continueWatching.unshift({
                    title: item.title,
                    image: item.image,
                    type: item.type,
                    progress: 30, // Progreso inicial simulado
                    timestamp: Date.now()
                });
                // Limitar a 10 items
                if (continueWatching.length > 10) {
                    continueWatching = continueWatching.slice(0, 10);
                }
            }
            saveData();
            updateContinueCarousel();
        }

        // Actualizar carrusel continuar viendo - Simplificado
        function updateContinueCarousel() {
            const carousel = document.getElementById('continue-carousel');
            carousel.innerHTML = '';
            
            // Ordenar por timestamp descendente
            const sortedContinue = [...continueWatching].sort((a, b) => b.timestamp - a.timestamp);
            
            sortedContinue.forEach(item => {
                let contentItem;
                if (item.type === 'series') {
                    contentItem = seriesData.find(s => s.title === item.title);
                } else {
                    contentItem = moviesData.find(m => m.title === item.title);
                }
                
                if (contentItem) {
                    const itemEl = document.createElement('div');
                    itemEl.className = 'carousel-item';
                    itemEl.addEventListener('click', function() {
                        if (item.type === 'series') {
                            openSeriesModal(contentItem);
                        } else {
                            openMovieModal(contentItem);
                        }
                    });
                    
                    const img = document.createElement('img');
                    img.src = item.image || contentItem.image;
                    img.alt = item.title;
                    img.onerror = function() {
                        this.src = createPlaceholderImage(item.title);
                    };
                    
                    const progressWrapper = document.createElement('div');
                    progressWrapper.className = 'progress-bar-wrapper';
                    
                    const progressFill = document.createElement('div');
                    progressFill.className = 'progress-bar-fill';
                    progressFill.style.width = `${item.progress}%`;
                    
                    progressWrapper.appendChild(progressFill);
                    itemEl.appendChild(img);
                    itemEl.appendChild(progressWrapper);
                    carousel.appendChild(itemEl);
                }
            });
        }

        // Agregar a Mi Lista
        function addToMyList(item) {
            if (!myList.some(m => m.title === item.title && m.type === item.type)) {
                myList.push(item);
                saveData();
                updateSeriesCarousel();
                updateMoviesCarousel();
                updateMyListViews();
                
                // Actualizar botón en el modal
                if (item.type === 'series') {
                    document.getElementById('mylist-button').textContent = '✓ Mi lista';
                    document.getElementById('mylist-button').classList.add('play-button');
                    document.getElementById('mylist-button').classList.remove('info-button');
                } else {
                    document.getElementById('movie-mylist-button').textContent = '✓ Mi lista';
                    document.getElementById('movie-mylist-button').classList.add('play-button');
                    document.getElementById('movie-mylist-button').classList.remove('info-button');
                }
            }
        }

        // Quitar de Mi Lista
        function removeFromMyList(item) {
            const index = myList.findIndex(m => m.title === item.title && m.type === item.type);
            if (index > -1) {
                myList.splice(index, 1);
                saveData();
                updateSeriesCarousel();
                updateMoviesCarousel();
                updateMyListViews();
                
                // Actualizar botón en el modal si está abierto
                if (item.type === 'series' && currentSeries && currentSeries.title === item.title) {
                    document.getElementById('mylist-button').textContent = '+ Mi lista';
                    document.getElementById('mylist-button').classList.remove('play-button');
                    document.getElementById('mylist-button').classList.add('info-button');
                } else if (item.type === 'movie' && currentMovie && currentMovie.title === item.title) {
                    document.getElementById('movie-mylist-button').textContent = '+ Mi lista';
                    document.getElementById('movie-mylist-button').classList.remove('play-button');
                    document.getElementById('movie-mylist-button').classList.add('info-button');
                }
            }
        }

        // Mostrar página principal
        function showHome() {
            document.getElementById('banner-section').style.display = 'flex';
            document.getElementById('series-section').style.display = 'block';
            document.getElementById('movies-section').style.display = 'block';
            document.getElementById('continue-section').style.display = 'block';
            document.getElementById('mylist-section').style.display = 'none';
            updateSeriesCarousel();
            updateMoviesCarousel();
            updateContinueCarousel();
        }

        // Mostrar solo series
        function showSeries() {
            document.getElementById('banner-section').style.display = 'flex';
            document.getElementById('series-section').style.display = 'block';
            document.getElementById('movies-section').style.display = 'none';
            document.getElementById('continue-section').style.display = 'block';
            document.getElementById('mylist-section').style.display = 'none';
            updateSeriesCarousel();
            updateContinueCarousel();
        }

        // Mostrar solo películas
        function showMovies() {
            document.getElementById('banner-section').style.display = 'flex';
            document.getElementById('series-section').style.display = 'none';
            document.getElementById('movies-section').style.display = 'block';
            document.getElementById('continue-section').style.display = 'block';
            document.getElementById('mylist-section').style.display = 'none';
            updateMoviesCarousel();
            updateContinueCarousel();
        }

        // Mostrar Mi Lista
        function showMyList() {
            document.getElementById('banner-section').style.display = 'none';
            document.getElementById('series-section').style.display = 'none';
            document.getElementById('movies-section').style.display = 'none';
            document.getElementById('continue-section').style.display = 'none';
            document.getElementById('mylist-section').style.display = 'block';
            updateMyListViews();
        }

        // Abrir modal de serie - Agregar a continuar viendo
        function openSeriesModal(series) {
            currentSeries = series;
            addToContinueWatching(series); // Agregar al hacer click en la serie
            
            // Actualizar contenido del modal
            document.getElementById('modal-title').textContent = series.title;
            document.getElementById('modal-description').textContent = series.description;
            
            const modalHeader = document.getElementById('modal-header');
            if (series.image && !series.image.includes('svg')) {
                modalHeader.style.backgroundImage = `url(${series.image})`;
            } else {
                modalHeader.style.background = '#333';
            }
            
            // Actualizar información de temporadas
            const seasonsContainer = document.getElementById('seasons-container');
            seasonsContainer.innerHTML = '';
            
            // Contar temporadas con episodios
            let seasonCount = 0;
            for (const key in series.seasons) {
                if (series.seasons[key] && series.seasons[key].length > 0) seasonCount++;
            }
            document.getElementById('modal-seasons').textContent = `${seasonCount} Temporada${seasonCount > 1 ? 's' : ''}`;
            
            // Crear secciones para cada temporada
            for (const seasonNum in series.seasons) {
                const season = series.seasons[seasonNum];
                if (season && season.length > 0) {
                    const seasonSection = document.createElement('div');
                    seasonSection.className = 'season-section';
                    
                    const seasonTitle = document.createElement('h3');
                    seasonTitle.className = 'season-title';
                    seasonTitle.textContent = `Temporada ${seasonNum}`;
                    seasonSection.appendChild(seasonTitle);
                    
                    const episodesGrid = document.createElement('div');
                    episodesGrid.className = 'episodes-grid';
                    
                    season.forEach(episode => {
                        const episodeCard = document.createElement('div');
                        episodeCard.className = 'episode-card';
                        episodeCard.addEventListener('click', function() {
                            playEpisode(episode, series.title);
                        });
                        
                        const episodeImage = document.createElement('div');
                        episodeImage.className = 'episode-image';
                        
                        if (episode.logo && !episode.logo.includes('svg')) {
                            episodeImage.innerHTML = `<img src="${episode.logo}" alt="${episode.title}" style="width:100%;height:100%;object-fit:cover;" onerror="this.parentElement.innerHTML='<div>Ep ${episode.episode}</div>'">`;
                        } else {
                            episodeImage.innerHTML = `<div>Ep ${episode.episode}</div>`;
                        }
                        
                        const episodeInfo = document.createElement('div');
                        episodeInfo.className = 'episode-info';
                        
                        const episodeNumber = document.createElement('div');
                        episodeNumber.className = 'episode-number';
                        episodeNumber.textContent = `Episodio ${episode.episode}`;
                        
                        const episodeName = document.createElement('div');
                        episodeName.className = 'episode-name';
                        episodeName.textContent = episode.cleanTitle || episode.title;
                        
                        episodeInfo.appendChild(episodeNumber);
                        episodeInfo.appendChild(episodeName);
                        
                        episodeCard.appendChild(episodeImage);
                        episodeCard.appendChild(episodeInfo);
                        
                        episodesGrid.appendChild(episodeCard);
                    });
                    
                    seasonSection.appendChild(episodesGrid);
                    seasonsContainer.appendChild(seasonSection);
                }
            }
            
            // Configurar botón Mi Lista
            const mylistButton = document.getElementById('mylist-button');
            if (myList.some(m => m.title === series.title && m.type === 'series')) {
                mylistButton.textContent = '✓ Mi lista';
                mylistButton.classList.add('play-button');
                mylistButton.classList.remove('info-button');
                mylistButton.onclick = function() {
                    removeFromMyList(series);
                };
            } else {
                mylistButton.textContent = '+ Mi lista';
                mylistButton.classList.remove('play-button');
                mylistButton.classList.add('info-button');
                mylistButton.onclick = function() {
                    addToMyList(series);
                };
            }
            
            // Mostrar modal
            document.getElementById('series-modal').style.display = 'block';
            
            // Configurar botón de reproducción
            document.getElementById('modal-play').onclick = function() {
                playFirstEpisode(series);
            };
        }

        // Abrir modal de película
        function openMovieModal(movie) {
            currentMovie = movie;
            addToContinueWatching(movie);
            
            // Actualizar contenido del modal
            document.getElementById('movie-modal-title').textContent = movie.title;
            document.getElementById('movie-modal-description').textContent = movie.description;
            
            const modalHeader = document.getElementById('movie-modal-header');
            if (movie.image && !movie.image.includes('svg')) {
                modalHeader.style.backgroundImage = `url(${movie.image})`;
            } else {
                modalHeader.style.background = '#333';
            }
            
            // Configurar botón Mi Lista
            const mylistButton = document.getElementById('movie-mylist-button');
            if (myList.some(m => m.title === movie.title && m.type === 'movie')) {
                mylistButton.textContent = '✓ Mi lista';
                mylistButton.classList.add('play-button');
                mylistButton.classList.remove('info-button');
                mylistButton.onclick = function() {
                    removeFromMyList(movie);
                };
            } else {
                mylistButton.textContent = '+ Mi lista';
                mylistButton.classList.remove('play-button');
                mylistButton.classList.add('info-button');
                mylistButton.onclick = function() {
                    addToMyList(movie);
                };
            }
            
            // Mostrar modal
            document.getElementById('movie-modal').style.display = 'block';
            
            // Configurar botón de reproducción
            document.getElementById('movie-modal-play').onclick = function() {
                playMovie(movie);
            };
        }

        // Reproducir episodio
        function playEpisode(episode, seriesTitle, startTime = 0) {
            const videoPlayer = document.getElementById('video-player');
            const videoElement = document.getElementById('video-element');
            const videoIframe = document.getElementById('video-iframe');
            const videoTitle = document.getElementById('video-title');
            const videoControls = document.getElementById('video-controls');
            
            currentVideo = {
                episode: episode,
                seriesTitle: seriesTitle
            };
            
            // Usar video para M3U
            isIframeMode = false;
            videoElement.style.display = 'block';
            videoIframe.style.display = 'none';
            videoElement.src = episode.url;
            videoTitle.textContent = `${seriesTitle} - T${episode.season}E${episode.episode}: ${episode.cleanTitle || episode.title}`;
            videoPlayer.style.display = 'block';
            videoControls.style.display = 'block';
            
            // Cerrar modal si está abierto
            document.getElementById('series-modal').style.display = 'none';
            
            // Configurar tiempo de inicio si es necesario
            if (startTime > 0) {
                videoElement.currentTime = startTime;
            }
            
            // Reproducir video
            videoElement.play();
            document.getElementById('play-pause-btn').innerHTML = '⏸️';
        }

        // Cerrar reproductor de video
        function closeVideoPlayer() {
            const videoPlayer = document.getElementById('video-player');
            const videoElement = document.getElementById('video-element');
            const videoIframe = document.getElementById('video-iframe');
            const videoControls = document.getElementById('video-controls');
            
            videoPlayer.style.display = 'none';
            
            if (isIframeMode) {
                videoIframe.src = '';
            } else {
                videoElement.pause();
                videoElement.src = '';
                
                // Reiniciar velocidad
                playbackSpeed = 1;
                videoElement.playbackRate = 1;
                document.getElementById('speed-btn').textContent = '1x';
            }
            
            // Restaurar controles
            videoControls.style.display = 'block';
            
            // Salir de pantalla completa si está activa
            if (document.fullscreenElement) {
                document.exitFullscreen();
            }
        }

        // Función para mover el carrusel
        function moveCarousel(carouselId, direction) {
            const container = document.getElementById(carouselId);
            const scrollAmount = container.offsetWidth * 0.8 * direction;
            container.scrollBy({
                left: scrollAmount,
                behavior: 'smooth'
            });
        }
    </script>
</body>
</html>
